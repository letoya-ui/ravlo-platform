{% extends "layouts/base.html" %}
{% block title %}Dialer Results{% endblock %}
{% block content %}

<main style="margin-left:260px; padding:2rem; background:#0f0f11; color:#e6e6e6; min-height:100vh;">
  <link rel="stylesheet" href="https://unpkg.com/lucide-static@latest/font/lucide.css">
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

  <style>
    .card {
      background:#15161a;border:1px solid #2b2f36;border-radius:14px;
      padding:1.4rem;box-shadow:0 0 18px rgba(122,184,255,0.25);
      margin-bottom:1.5rem;
    }
    h1,h2{color:#7ab8ff;margin-bottom:1rem;}
    .muted{color:#a5a7ad;font-size:.9rem;}
    .grid{display:grid;gap:1.2rem;}
    .g-2{grid-template-columns:repeat(2,minmax(0,1fr));}
    .btn{
      display:inline-flex;align-items:center;gap:.4rem;
      background:linear-gradient(180deg,#2a4a62,#1b2a38);
      border:1px solid #2a4a62;color:#cfe8ff;
      border-radius:10px;padding:.6rem 1.1rem;text-decoration:none;cursor:pointer;
    }
    .btn:hover{box-shadow:0 0 10px rgba(122,184,255,0.35);}
    .btn-outline{background:transparent;border:1px solid #2b2f36;color:#e6e6e6;}
    table{width:100%;border-collapse:collapse;}
    th,td{padding:.6rem .8rem;border-top:1px solid #2b2f36;text-align:left;}
    th{color:#9cb9d8;font-size:.85rem;text-transform:uppercase;}
    tr:hover{background:#1c1f25;}
    .badge{padding:.25rem .6rem;border-radius:999px;font-size:.78rem;}
    .b-success{background:#1b2a23;color:#43d19e;}
    .b-failed{background:#2a1b1b;color:#ff6b6b;}
    .b-voicemail{background:#2a2a1b;color:#ffdf6e;}
    .b-noanswer{background:#223f5a;color:#7ab8ff;}
  </style>

  <!-- Header -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;">
      <h1><i class="lucide lucide-phone-call"></i> Dialer Results</h1>
      <div style="display:flex;gap:.5rem;flex-wrap:wrap;">
        <a href="{{ url_for('crm.view_leads') }}" class="btn btn-outline"><i class="lucide lucide-users"></i> View Leads</a>
        <a href="{{ url_for('crm.add_lead') }}" class="btn btn-outline"><i class="lucide lucide-user-plus"></i> Add Lead</a>
      </div>
    </div>
    <p class="muted">Monitor all recent call activity, lead connection outcomes, and team performance.</p>
  </div>

  <!-- Stats Overview -->
  <div class="grid g-2">
    <div class="card">
      <h2>ðŸ“ž Call Summary</h2>
      <div id="chartCallSummary" style="height:260px;"></div>
    </div>
    <div class="card">
      <h2>ðŸ‘¥ Top Agents</h2>
      <div id="chartTopAgents" style="height:260px;"></div>
    </div>
  </div>

  <!-- Results Table -->
  <div class="card" style="overflow-x:auto;">
    <h2><i class="lucide lucide-activity"></i> Recent Calls</h2>
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Agent</th>
          <th>Lead</th>
          <th>Phone</th>
          <th>Status</th>
          <th>Duration</th>
          <th>Notes</th>
        </tr>
      </thead>
      <tbody>
        {% for c in calls %}
        <tr>
          <td>{{ c.timestamp.strftime('%b %d, %Y %I:%M %p') }}</td>
          <td>{{ c.agent_name or 'â€”' }}</td>
          <td>{{ c.lead_name or 'â€”' }}</td>
          <td>{{ c.phone or 'â€”' }}</td>
          <td>
            <span class="badge
              {% if c.status == 'Connected' %}b-success
              {% elif c.status == 'Voicemail' %}b-voicemail
              {% elif c.status == 'No Answer' %}b-noanswer
              {% else %}b-failed{% endif %}">
              {{ c.status }}
            </span>
          </td>
          <td>{{ c.duration or 'â€”' }}</td>
          <td>{{ c.notes or '' }}</td>
        </tr>
        {% else %}
        <tr><td colspan="7" class="muted" style="text-align:center;">No call records found.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- AI Summary -->
  <div class="card">
    <h2><i class="lucide lucide-brain-circuit"></i> AI Dialer Insight</h2>
    <p class="muted" id="aiInsight">Analyzing recent patterns...</p>
  </div>

  <script>
    // --- ApexCharts ---
    const baseOpt={chart:{toolbar:{show:false},foreColor:'#c9d3df'},grid:{borderColor:'#2a2e36'},dataLabels:{enabled:false},theme:{mode:'dark'}};

    new ApexCharts(document.querySelector("#chartCallSummary"),{
      ...baseOpt,
      chart:{...baseOpt.chart,type:'donut',height:260},
      series:[{{ summary.connected or 0 }},{{ summary.voicemail or 0 }},{{ summary.noanswer or 0 }},{{ summary.failed or 0 }}],
      labels:['Connected','Voicemail','No Answer','Failed'],
      colors:['#43d19e','#ffdf6e','#7ab8ff','#ff6b6b']
    }).render();

    new ApexCharts(document.querySelector("#chartTopAgents"),{
      ...baseOpt,
      chart:{...baseOpt.chart,type:'bar',height:260},
      series:[{name:'Calls',data:{{ agent_data|tojson }} }],
      xaxis:{categories:{{ agent_labels|tojson }}},
      colors:['#7ab8ff']
    }).render();

    // --- AI Insight (demo refresh) ---
    setTimeout(()=>{
      document.getElementById('aiInsight').innerHTML = `
        <strong>ðŸ¤– AI Insight:</strong> Best connection rate observed on <b>Tuesday 10 AM â€“ 2 PM</b>. 
        Agents with follow-up scripts improved contact ratio by <b>+27%</b>.`;
    },1200);
  </script>
</main>

{% endblock %}
