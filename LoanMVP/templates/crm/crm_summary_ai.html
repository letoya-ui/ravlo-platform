{% extends "layouts/base.html" %}
{% block content %}
<style>
  :root{--line:#2a2e36; --panel:#15161a; --text:#e6e6e6; --muted:#a5a7ad}
  .card{background:var(--panel); border:1px solid var(--line); border-radius:14px; padding:1rem}
  table{width:100%; border-collapse:collapse}
  th,td{padding:.6rem; border-top:1px solid var(--line); color:var(--text)}
  input{background:#0f0f11; border:1px solid var(--line); color:var(--text); border-radius:10px; padding:.45rem .6rem; width:100%}
  .btn{display:inline-flex; align-items:center; gap:.5rem; padding:.6rem .9rem; border-radius:10px; border:1px solid var(--line); color:var(--text); text-decoration:none; background:#1a1d23}
</style>


<div class="container-fluid py-4 text-light fade-in">
  <h2 class="mb-4">üß† AI-Powered CRM Summary</h2>
  <p class="text-muted">Real-time analytics and AI insights on leads, loans, and engagement.</p>

  <!-- ========== LIVE AI INSIGHT BANNER ========== -->
  <div id="aiInsight" class="alert alert-dark border-secondary shadow-sm mb-4 text-center">
    <strong>ü§ñ AI Insight:</strong> Loading latest summary...
  </div>

  <!-- ========== KPI CARDS ========== -->
  <div class="row g-3">
    <div class="col-md-3">
      <div class="card bg-dark border border-secondary rounded-3 p-3 text-center shadow-sm">
        <h6 class="text-muted text-uppercase small">Total Leads</h6>
        <h2 class="fw-bold">{{ stats.total_leads }}</h2>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-dark border border-secondary rounded-3 p-3 text-center shadow-sm">
        <h6 class="text-muted text-uppercase small">Active Loans</h6>
        <h2 class="fw-bold text-info">{{ stats.active_loans }}</h2>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-dark border border-secondary rounded-3 p-3 text-center shadow-sm">
        <h6 class="text-muted text-uppercase small">Closed Deals</h6>
        <h2 class="fw-bold text-success">{{ stats.closed_deals }}</h2>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-dark border border-secondary rounded-3 p-3 text-center shadow-sm">
        <h6 class="text-muted text-uppercase small">Conversion Rate</h6>
        <h2 class="fw-bold text-warning">{{ stats.conversion_rate }}%</h2>
      </div>
    </div>
  </div>

  <!-- ========== LEAD SOURCE PERFORMANCE ========== -->
  <div class="card bg-dark border border-secondary rounded-3 mt-4 shadow-sm">
    <div class="card-header border-secondary">
      <h5 class="mb-0 text-light">üìà Lead Source Performance</h5>
    </div>
    <div class="card-body">
      <canvas id="leadChart" height="120"></canvas>
    </div>
  </div>

  <!-- ========== RECENT LEADS TABLE ========== -->
  <div class="card bg-dark border border-secondary rounded-3 mt-4 shadow-sm">
    <div class="card-header border-secondary">
      <h5 class="mb-0 text-light">üßæ Recent Leads</h5>
    </div>
    <div class="card-body table-responsive">
      <table class="table table-dark table-hover align-middle">
        <thead class="table-secondary text-dark">
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Source</th>
            <th>Status</th>
            <th>Created</th>
          </tr>
        </thead>
        <tbody>
          {% for lead in leads %}
          <tr>
            <td>{{ lead.name }}</td>
            <td>{{ lead.email }}</td>
            <td>{{ lead.source }}</td>
            <td>
              <span class="badge bg-{% if lead.status == 'converted' %}success{% elif lead.status == 'lost' %}danger{% else %}secondary{% endif %}">
                {{ lead.status|capitalize }}
              </span>
            </td>
            <td>{{ lead.created_at.strftime("%Y-%m-%d %H:%M") }}</td>
          </tr>
          {% else %}
          <tr><td colspan="5" class="text-center text-muted">No recent leads.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- ========== SCRIPTS ========== -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Live AI refresh (every 60s)
function updateInsight() {
  fetch('{{ url_for("admin.ai_refresh") }}')
    .then(res => res.json())
    .then(data => {
      document.getElementById('aiInsight').innerHTML = `<strong>ü§ñ AI Insight:</strong> ${data.message}`;
    })
    .catch(() => {
      document.getElementById('aiInsight').innerHTML = "<strong>‚ö†Ô∏è</strong> AI service temporarily unavailable.";
    });
}
updateInsight();
setInterval(updateInsight, 60000);

// Lead source chart
const ctx = document.getElementById('leadChart').getContext('2d');
new Chart(ctx, {
  type: 'doughnut',
  data: {
    labels: {{ chart.labels|safe }},
    datasets: [{
      data: {{ chart.values|safe }},
      backgroundColor: ['#c4a000', '#1a3d2f', '#999', '#666', '#2b2b2b'],
      borderWidth: 1
    }]
  },
  options: {
    plugins: { legend: { labels: { color: '#e0e0e0' } } },
  }
});
</script>

<style>
.fade-in { animation: fadeIn .4s ease-in; }
@keyframes fadeIn { from{opacity:0;transform:translateY(10px);} to{opacity:1;transform:translateY(0);} }
.card:hover { transform:translateY(-3px);transition:0.2s ease;border-color:#c4a000; }
</style>

{% endblock %}
