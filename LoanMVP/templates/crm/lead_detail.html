{% extends "layouts/base.html" %}
{% block title %}Lead Detail{% endblock %}
{% block content %}

<main style="margin-left:260px; padding:2rem; background:#0f0f11; color:#e6e6e6; min-height:100vh;">
  <link rel="stylesheet" href="https://unpkg.com/lucide-static@latest/font/lucide.css">
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

  <style>
    .card {
      background:#15161a;border:1px solid #2b2f36;border-radius:14px;
      padding:1.4rem;box-shadow:0 0 18px rgba(122,184,255,0.25);
      margin-bottom:1.5rem;
    }
    h1,h2,h3{color:#7ab8ff;margin-bottom:.6rem;}
    .muted{color:#a5a7ad;font-size:.9rem;}
    .grid{display:grid;gap:1.2rem;}
    .g-2{grid-template-columns:repeat(2,minmax(0,1fr));}
    .btn{
      display:inline-flex;align-items:center;gap:.4rem;
      background:linear-gradient(180deg,#2a4a62,#1b2a38);
      border:1px solid #2a4a62;color:#cfe8ff;
      border-radius:10px;padding:.6rem 1.1rem;text-decoration:none;cursor:pointer;
    }
    .btn:hover{box-shadow:0 0 10px rgba(122,184,255,0.35);}
    .btn-outline{background:transparent;border:1px solid #2b2f36;color:#e6e6e6;}
    .badge{padding:.25rem .6rem;border-radius:999px;font-size:.78rem;}
    .b-hot{background:#1b2a23;color:#43d19e;}
    .b-warm{background:#2a2a1b;color:#ffdf6e;}
    .b-cold{background:#2a1b1b;color:#ff6b6b;}
    input,textarea,select{
      width:100%;background:#0f0f11;color:#e6e6e6;border:1px solid #2b2f36;
      border-radius:10px;padding:.6rem .8rem;margin-top:.35rem;
    }
    textarea{min-height:80px;}
    .section-title{color:#9cb9d8;font-size:.85rem;text-transform:uppercase;margin-bottom:.3rem;}
  </style>

  <!-- Header -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;">
      <h1><i class="lucide lucide-user"></i> {{ lead.name }}</h1>
      <div style="display:flex;gap:.5rem;flex-wrap:wrap;">
        <a href="{{ url_for('crm.view_leads') }}" class="btn-outline btn">‚Üê Back to Leads</a>
        <a href="{{ url_for('crm.update_lead', lead_id=lead.id) }}" class="btn"><i class="lucide lucide-pencil"></i> Edit Lead</a>
      </div>
    </div>
    <p class="muted">Lead ID: {{ lead.id }} ‚Ä¢ Created {{ lead.created_at.strftime('%b %d, %Y') }}</p>
  </div>

  <!-- Overview Grid -->
  <div class="grid g-2">
    <!-- Lead Information -->
    <div class="card">
      <h2>üìã Lead Information</h2>
      <p><strong>Email:</strong> {{ lead.email or '‚Äî' }}</p>
      <p><strong>Phone:</strong> {{ lead.phone or '‚Äî' }}</p>
      <p><strong>Source:</strong> {{ lead.source or 'Manual Entry' }}</p>
      <p><strong>Status:</strong> {{ lead.status or 'New' }}</p>
      <p>
        <strong>Score:</strong>
        <span class="badge
          {% if lead.score >= 75 %}b-hot
          {% elif lead.score >= 50 %}b-warm
          {% else %}b-cold{% endif %}">
          {{ lead.score or 0 }}
        </span>
      </p>
    </div>

    <!-- Contact Summary -->
    <div class="card">
      <h2>üìû Last Contact</h2>
      {% if lead.last_contact %}
      <p>{{ lead.last_contact.strftime('%b %d, %Y %I:%M %p') }}</p>
      <p class="muted">Handled by: {{ lead.assigned_to or 'Unassigned' }}</p>
      {% else %}
      <p class="muted">No previous contact logged.</p>
      {% endif %}
      <hr style="border-color:#2b2f36;margin:1rem 0;">
      <form method="POST" action="{{ url_for('crm.update_lead_notes', lead_id=lead.id) }}">
        <label class="section-title">Add Note or Update Status</label>
        <textarea name="notes" placeholder="e.g., Left voicemail or scheduled call..."></textarea>
        <select name="status">
          <option value="">‚Äî Select Status ‚Äî</option>
          <option>Contacted</option>
          <option>Follow-Up</option>
          <option>Qualified</option>
          <option>Unqualified</option>
          <option>Closed Won</option>
          <option>Closed Lost</option>
        </select>
        <button type="submit" class="btn" style="margin-top:1rem;">üíæ Save Update</button>
      </form>
    </div>
  </div>

  <!-- AI Insights -->
  <div class="card">
    <h2>ü§ñ AI Insights</h2>
    <p class="muted" id="aiSummary">Analyzing lead behavior and communication patterns...</p>
  </div>

  <!-- Call History -->
  <div class="card" style="overflow-x:auto;">
    <h2>üìû Call History</h2>
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Agent</th>
          <th>Status</th>
          <th>Duration</th>
          <th>Notes</th>
        </tr>
      </thead>
      <tbody>
        {% for call in lead.calls %}
        <tr>
          <td>{{ call.timestamp.strftime('%b %d, %Y %I:%M %p') }}</td>
          <td>{{ call.agent_name or '‚Äî' }}</td>
          <td>{{ call.status or '‚Äî' }}</td>
          <td>{{ call.duration or '‚Äî' }}</td>
          <td>{{ call.notes or '' }}</td>
        </tr>
        {% else %}
        <tr><td colspan="5" class="muted" style="text-align:center;">No calls recorded yet.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <script>
    // --- Simulated AI Summary (replace with API call if needed) ---
    setTimeout(()=>{
      document.getElementById('aiSummary').innerHTML = `
        <strong>ü§ñ AI Analysis:</strong> This lead has shown <b>{{ lead.engagement or 'moderate' }}</b> engagement.
        Conversion probability: <b>{{ lead.ai_prediction or '67%' }}</b>.
        Suggested next action: follow up within <b>48 hours</b>.`;
    }, 1000);
  </script>
</main>

{% endblock %}
