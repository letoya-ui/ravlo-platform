{% extends "layouts/base.html" %}
{% block title %}Campaign Command Center{% endblock %}
{% block content %}

<main class="dashboard-main" style="margin-left:260px; padding:2rem;">
  <div class="wrap">
    <!-- LEFT PANEL -->
    <section class="lhs">
      <!-- HEADER -->
      <div class="card header-bar">
        <div>
          <h1>ğŸ“£ Campaign Command Center</h1>
          <p class="muted">Create, track, and automate AI-driven marketing campaigns.</p>
        </div>
        <div class="action-buttons">
          <a href="{{ url_for('loan_officer.dashboard') }}" class="btn btn-nav">ğŸ  Dashboard</a>
          <a href="{{ url_for('crm.dashboard') }}" class="btn btn-nav">ğŸ“‡ CRM</a>
        </div>
      </div>

      <!-- NEW CAMPAIGN FORM -->
      <div class="card fade-in">
        <h3 class="mb-3">New Campaign</h3>
        <a href="{{ url_for('loan_officer.create_campaign') }}" class="btn btn-primary">
          â• Create Campaign
        </a>
          <div>
            <label>Channel</label>
            <select name="channel" class="input-dark">
              <option value="email">Email</option>
              <option value="sms">Text</option>
            </select>
          </div>
          <div>
            <label>Lead</label>
            <select name="lead_id" class="input-dark">
              {% for lead in leads %}
              <option value="{{ lead.id }}">{{ lead.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-span-2">
            <label>Subject</label>
            <input name="subject" placeholder="Enter campaign subject..." class="input-dark">
          </div>
          <div class="col-span-2">
            <label>Message Body</label>
            <textarea name="body" class="input-dark" rows="4" placeholder="Type or generate a message..."></textarea>
          </div>
          <div class="col-span-2 d-flex justify-content-end gap-2 mt-2">
            <button class="btn btn-primary" type="submit">ğŸ’¾ Save Draft</button>
            <button class="btn btn-outline" type="button" id="aiGenerate">ğŸ¤– Generate AI Message</button>
          </div>
        </form>
      </div>

      <!-- FILTER BAR -->
      <div class="filter-bar card">
        <h5 class="mb-2">Filter Campaigns</h5>
        <div class="d-flex flex-wrap gap-2">
          <button class="chip" onclick="filterCampaigns('all')">All</button>
          <button class="chip" onclick="filterCampaigns('draft')">Drafts</button>
          <button class="chip" onclick="filterCampaigns('sent')">Sent</button>
        </div>
      </div>

      <!-- RECENT CAMPAIGNS -->
      <div class="card fade-in">
        <h3 class="mb-3">Recent Campaigns</h3>
        {% if messages %}
        <div class="table-responsive">
          <table class="table table-dark table-hover align-middle" id="campaignTable">
            <thead class="table-secondary text-dark">
              <tr>
                <th>Subject</th><th>Lead</th><th>Channel</th><th>Status</th><th>Date</th><th>Action</th>
              </tr>
            </thead>
            <tbody>
              {% for m in messages %}
              <tr data-status="{{ m.status }}">
                <td>{{ m.subject }}</td>
                <td>{{ m.lead.name if m.lead else 'â€”' }}</td>
                <td>{{ m.channel|capitalize }}</td>
                <td>
                  <span class="badge {% if m.status == 'sent' %}st-approved{% else %}st-pending{% endif %}">
                    {{ m.status|capitalize }}
                  </span>
                </td>
                <td>{{ m.created_at.strftime("%b %d, %Y") if m.created_at else "â€”" }}</td>
                <td>
                  <form method="POST" action="{{ url_for('campaigns.send_campaign', msg_id=m.id) }}">
                    <button class="btn btn-sm btn-primary w-100">Send</button>
                  </form>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
          <p class="muted">No campaigns found.</p>
        {% endif %}
      </div>

      <!-- PERFORMANCE CHART -->
      <div class="card fade-in">
        <h3 class="mb-3">ğŸ“Š Campaign Performance</h3>
        <div id="campaignChart" style="height:260px;"></div>
      </div>
    </section>

    <!-- RIGHT PANEL -->
    <aside class="rhs grid">
      <div class="card">
        <h3>Smart Actions</h3>
        <div class="button-column">
          <a href="{{ url_for('loan_officer.leads') }}" class="btn btn-nav">ğŸ“ Manage Leads</a>
          <a href="{{ url_for('loan_officer.pipeline') }}" class="btn btn-nav">ğŸ“ˆ View Pipeline</a>
          <a href="{{ url_for('loan_officer.reports') }}" class="btn btn-nav">ğŸ“Š Reports</a>
        </div>
      </div>

      <div class="card ai-panel">
        <h3>ğŸ§  AI Campaign Analyst</h3>
        <p class="muted small mb-2">AI analyzes trends and suggests your next outreach move.</p>
        <div id="aiInsight" class="muted small mb-3">Analyzing recent campaigns...</div>
        <button id="aiQuickGen" class="btn btn-primary full-width">âš¡ Quick AI Suggestion</button>
      </div>
    </aside>
  </div>
</main>

<!-- ================= STYLE ================= -->
<style>
:root{
  --bg:#0f0f11;--panel:#15161a;--text:#e6e6e6;
  --muted:#a5a7ad;--line:#2b2b2b;--accent:#7ab8ff;
}
.wrap{display:flex;gap:1.25rem;flex-wrap:wrap;}
.lhs{flex:1 1 68%;min-width:620px;}
.rhs{flex:1 1 30%;min-width:280px;}
.card{background:linear-gradient(180deg,#15161a,#0f0f11);
  border:1px solid var(--line);border-radius:14px;padding:1.4rem;
  box-shadow:0 0 10px rgba(255,255,255,0.03);}
h1,h3,h5{margin-bottom:.4rem;}
.muted{color:var(--muted);}
.header-bar{display:flex;justify-content:space-between;align-items:flex-start;gap:1rem;}
.action-buttons{display:flex;gap:.5rem;flex-wrap:wrap;}
.btn{display:inline-flex;align-items:center;justify-content:center;
  gap:.4rem;padding:.65rem 1rem;border-radius:10px;border:1px solid var(--line);
  text-decoration:none;color:var(--text);background:#1a1d23;transition:.25s;white-space:nowrap;}
.btn:hover{background:#2a2e36;color:#fff;box-shadow:0 0 8px rgba(255,255,255,0.08);}
.btn-primary{background:linear-gradient(90deg,#2b2b2b,#444);color:#f4f4f4;}
.btn-outline{background:transparent;border:1px solid #555;color:#ccc;}
.btn-nav{background:#141517;border:1px solid #3a3a3a;font-size:.9rem;}
.input-dark{width:100%;padding:.6rem .8rem;border:1px solid var(--line);
  border-radius:10px;background:#0f0f11;color:var(--text);margin-top:.3rem;}
.button-column{display:flex;flex-direction:column;gap:.6rem;margin-top:.5rem;}
.badge{padding:.25rem .6rem;border-radius:6px;font-size:.8rem;}
.st-approved{background:#1b2a23;color:#9af2c5;}
.st-pending{background:#2a1b1b;color:#ff9d9d;}
.form-grid label{font-weight:600;font-size:.9rem;color:var(--muted);}
.chip{padding:.4rem .9rem;border:1px solid var(--line);
  border-radius:999px;background:#1a1d23;color:var(--text);
  cursor:pointer;transition:.2s;font-size:.85rem;}
.chip:hover{background:#2b2b2b;}
.full-width{width:100%;}
.fade-in{animation:fadeIn .3s ease-in;}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px);}to{opacity:1;transform:translateY(0);}}
</style>

<!-- ================= JS ================= -->
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
function filterCampaigns(status){
  const rows=document.querySelectorAll("#campaignTable tbody tr");
  rows.forEach(r=>r.style.display=(status==='all'||r.dataset.status===status)?'':'none');
}

document.getElementById("aiGenerate").onclick = async ()=>{
  const topic=prompt("Message topic (follow-up, refinance, etc.)")||"general";
  const lead=prompt("Borrower name (optional):")||"client";
  const res=await fetch("{{ url_for('loan_officer.ai_generator') }}",{
    method:"POST",
    headers:{"Content-Type":"application/x-www-form-urlencoded"},
    body:`topic=${topic}&lead_name=${lead}`
  });
  const data=await res.json();
  document.querySelector("textarea[name='body']").value=data.text;
};

document.getElementById("aiQuickGen").onclick=async()=>{
  const res=await fetch("{{ url_for('loan_officer.ai_generator') }}",{method:"POST"});
  const data=await res.json();
  document.getElementById("aiInsight").innerHTML="<strong>AI:</strong> "+data.text;
};

// Chart
new ApexCharts(document.querySelector("#campaignChart"),{
  chart:{type:"area",height:260,toolbar:{show:false}},
  theme:{mode:"dark"},
  series:[
    {name:"Emails Sent",data:[12,15,18,22,28,35,40,42]},
    {name:"Responses",data:[5,6,8,11,14,17,19,21]}
  ],
  xaxis:{categories:['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug']},
  colors:['#7ab8ff','#43d19e']
}).render();
</script>
{% endblock %}
