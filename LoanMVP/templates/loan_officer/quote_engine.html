{% extends "layouts/base.html" %}
{% block title %}Loan Quote Engine{% endblock %}
{% block content %}
<style>
  :root{--line:#2a2e36; --panel:#15161a; --text:#e6e6e6; --muted:#a5a7ad}
  .card{background:var(--panel); border:1px solid var(--line); border-radius:14px; padding:1rem}
  table{width:100%; border-collapse:collapse}
  th,td{padding:.6rem; border-top:1px solid var(--line); color:var(--text)}
  input{background:#0f0f11; border:1px solid var(--line); color:var(--text); border-radius:10px; padding:.45rem .6rem; width:100%}
  .btn{display:inline-flex; align-items:center; gap:.5rem; padding:.6rem .9rem; border-radius:10px; border:1px solid var(--line); color:var(--text); text-decoration:none; background:#1a1d23}
</style>

 <div class="container-fluid py-4 text-light">
  <h3 class="mb-4" style="color:#73b7ff;">
    <i class="fas fa-percentage"></i> Loan Quote Engine
  </h3>
  <p class="text-muted mb-4">
    Instantly compare lender options and estimated loan terms for your borrowers.
  </p>

  <!-- Loan Details Summary -->
  <div class="card mb-4 p-4" style="background-color:#181a1b;border:1px solid #2b2b2b;border-radius:10px;">
    <h5 class="text-secondary mb-3">Borrower Loan Overview</h5>
    <div class="row">
      <div class="col-md-4">
        <p><strong>Borrower:</strong> {{ borrower_name or 'N/A' }}</p>
      </div>
      <div class="col-md-4">
        <p><strong>Loan Type:</strong> {{ loan_type or 'Unknown' }}</p>
      </div>
      <div class="col-md-4">
        <p><strong>Requested Amount:</strong> ${{ "{:,.2f}".format(amount or 0) }}</p>
      </div>
    </div>
  </div>

  <!-- Quote Comparison Table -->
  <div class="card p-4" style="background-color:#181a1b;border:1px solid #2b2b2b;border-radius:10px;">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="text-secondary">Available Quotes</h5>
      <button class="btn btn-outline-info btn-sm" onclick="generateAIQuote()">ðŸ¤– Generate AI Quote</button>
    </div>

    <div class="table-responsive">
      <table class="table table-dark table-hover align-middle mb-0">
        <thead class="table-secondary text-dark">
          <tr>
            <th>Lender</th>
            <th>Interest Rate</th>
            <th>LTV</th>
            <th>Term</th>
            <th>Monthly Payment</th>
            <th>Decision</th>
          </tr>
        </thead>
        <tbody id="quoteTable">
          {% for quote in quotes %}
          <tr>
            <td>{{ quote.lender }}</td>
            <td>{{ quote.rate }}</td>
            <td>{{ quote.ltv }}</td>
            <td>{{ quote.term if quote.term else '30 years' }}</td>
            <td>${{ quote.monthly_payment if quote.monthly_payment else 'N/A' }}</td>
            <td>
              <button class="btn btn-sm btn-outline-success" onclick="selectQuote('{{ quote.lender }}')">
                Select
              </button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Dynamic Chart -->
  <div class="card mt-4 p-4" style="background-color:#181a1b;border:1px solid #2b2b2b;border-radius:10px;">
    <h5 class="text-secondary mb-3">Quote Comparison Chart</h5>
    <div id="quoteChart" style="height: 280px;"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
let chart;

function updateChart() {
  const rows = Array.from(document.querySelectorAll("#quoteTable tr"));
  const lenders = rows.map(r => r.children[0].innerText);
  const rates = rows.map(r => parseFloat(r.children[1].innerText.replace('%', '')) || 0);

  const options = {
    chart: { type: 'bar', height: 280, background: 'transparent', foreColor: '#ccc' },
    series: [{ name: 'Interest Rate (%)', data: rates }],
    xaxis: { categories: lenders },
    plotOptions: { bar: { borderRadius: 6, columnWidth: '55%' } },
    fill: { gradient: { shade: 'dark', type: 'vertical', shadeIntensity: 0.3, gradientToColors: ['#73b7ff'], opacityFrom: 0.9, opacityTo: 0.5 } },
    colors: ['#3fa7ff']
  };

  if (!chart) {
    chart = new ApexCharts(document.querySelector("#quoteChart"), options);
    chart.render();
  } else {
    chart.updateSeries([{ data: rates }]);
  }
}

function selectQuote(lender) {
  alert(`âœ… Quote selected from ${lender}`);
}

function generateAIQuote() {
  const table = document.getElementById("quoteTable");
  const newRow = table.insertRow();
  newRow.innerHTML = `
    <td>AI Generated Capital</td>
    <td>7.08%</td>
    <td>81%</td>
    <td>30 years</td>
    <td>$2,089</td>
    <td><button class="btn btn-sm btn-outline-success" onclick="selectQuote('AI Generated Capital')">Select</button></td>`;
  updateChart();
  alert('ðŸ¤– AI-generated quote added successfully.');
}

window.onload = updateChart;
</script>

{% endblock %}
