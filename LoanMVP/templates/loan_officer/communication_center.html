{% extends "layouts/base.html" %}
{% block title %}Communication Center â€¢ Loan Officer{% endblock %}

{% block content %}

<style>
/* Layout */
.comm-container {
    display: grid;
    grid-template-columns: 1fr 1.3fr;
    gap: 2rem;
}

/* Left Panel */
.comm-left {
    background: var(--panel);
    border: 1px solid var(--line);
    padding: 1.5rem;
    border-radius: 16px;
    height: 85vh;
    overflow-y: auto;
    box-shadow: 0 0 18px rgba(122,184,255,.25);
}

.comm-left h2 {
    font-size: 1.4rem;
    margin-bottom: 1rem;
    text-shadow: 0 0 12px rgba(122,184,255,.45);
}

/* Right Panel - AI messaging */
.comm-right {
    background: var(--panel);
    border: 1px solid var(--line);
    border-radius: 16px;
    display: flex;
    flex-direction: column;
    height: 85vh;
    box-shadow: 0 0 18px rgba(122,184,255,.35);
}

.ai-messages {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
}

.ai-msg {
    margin-bottom: 1rem;
    padding: 1rem;
    border-radius: 12px;
    line-height: 1.4rem;
    font-size: 0.95rem;
}
.ai-msg.user { background: rgba(122,184,255,0.12); border: 1px solid var(--accent); }
.ai-msg.ai { background: #0f1115; border: 1px solid var(--line); }

/* Input Bar */
.ai-input-bar {
    padding: 1rem;
    border-top: 1px solid var(--line);
    display: flex;
    gap: 1rem;
}
.ai-input-bar textarea {
    flex: 1;
    background: #0f1115;
    border: 1px solid var(--line);
    color: white;
    padding: 0.7rem;
    height: 70px;
    border-radius: 12px;
    resize: none;
}
.ai-input-bar button {
    background: var(--accent);
    color: black;
    padding: 0 1.5rem;
    border-radius: 12px;
    border: none;
    font-weight: 700;
    cursor: pointer;
}
.ai-input-bar button:hover {
    background: white;
}

/* Copy buttons */
.copy-btn {
    background: #222;
    padding: 6px 10px;
    border-radius: 6px;
    border: 1px solid var(--line);
    cursor: pointer;
    margin-right: 6px;
}
.copy-btn:hover { background: var(--hover); }

/* Communication Log */
.comm-log-entry {
    padding: 1rem;
    border-bottom: 1px solid var(--line);
    margin-bottom: 0.5rem;
}
.comm-log-entry strong {
    color: var(--accent);
}

</style>


<h1 class="intake-title">Borrower Communication Center</h1>

<div class="comm-container">

    <!-- LEFT PANEL â€” Borrower + Loan Summary -->
    <div class="comm-left">

        <h2>Borrower Information</h2>
        <p><strong>Name:</strong> {{ borrower.full_name }}</p>
        <p><strong>Email:</strong> {{ borrower.email }}</p>
        <p><strong>Phone:</strong> {{ borrower.phone }}</p>
        <p><strong>Address:</strong> {{ borrower.address }} {{ borrower.city }} {{ borrower.state }}</p>

        <h2>Loan Details</h2>
        {% if loan %}
            <p><strong>Loan Type:</strong> {{ loan.loan_type }}</p>
            <p><strong>Amount:</strong> ${{ loan.amount }}</p>
            <p><strong>Property Value:</strong> ${{ loan.property_value }}</p>
            <p><strong>Address:</strong> {{ loan.property_address }}</p>
        {% else %}
            <p>No loan file yet.</p>
        {% endif %}

        <h2>Credit Summary</h2>
        {% if credit %}
            <p><strong>Score:</strong> {{ credit.credit_score }}</p>
            <p><strong>Monthly Debts:</strong> ${{ credit.monthly_debt_total }}</p>
        {% else %}
            <p>No credit report yet.</p>
        {% endif %}

        <h2>Communication Log</h2>
        {% for log in logs %}
            <div class="comm-log-entry">
                <strong>{{ log.channel|capitalize }}</strong>
                <br>
                <small>{{ log.timestamp.strftime('%Y-%m-%d %I:%M %p') }}</small>
                <p>{{ log.message }}</p>
            </div>
        {% endfor %}
    </div>
    <div id="docPopup" class="doc-popup hidden">
    <h4>ðŸ“„ Document Opportunity</h4>
    <p id="docPopupText"></p>
    <div id="docPopupButtons"></div>
    <button class="close-btn" onclick="closeDocPopup()">Close</button>
</div>

    <!-- RIGHT PANEL â€” AI Messaging -->
    <div class="comm-right">

        <div class="ai-messages" id="commMessages"></div>

        <div class="ai-input-bar">
            <textarea id="commInput" placeholder="Ask AI: Create call, SMS, and email scripts."></textarea>
            <button onclick="sendCommAI()">Ask</button>
        </div>

    </div>
<style>
.doc-popup {
    position: fixed;
    bottom: 30px;
    right: 30px;
    background: var(--panel);
    border: 1px solid var(--accent);
    box-shadow: 0 0 16px rgba(122,184,255,0.45);
    padding: 1.2rem;
    border-radius: 12px;
    width: 280px;
    z-index: 500;
    animation: fadeIn .3s ease;
}

.doc-popup.hidden {
    display: none;
}

.doc-popup button {
    background: var(--accent);
    border: none;
    padding: 0.5rem 0.8rem;
    margin-top: 0.7rem;
    border-radius: 6px;
    cursor: pointer;
    width: 100%;
    color: white;
    font-weight: 600;
}

.close-btn {
    background: #444 !important;
}
</style>

</div>


<script>
/* Add messages to panel */
function addCommMsg(msg, who) {
    const box = document.getElementById("commMessages");
    let div = document.createElement("div");
    div.classList.add("ai-msg", who);
    div.innerHTML = msg.replace(/\n/g, "<br>");
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
}

/* Send message to AI */
function sendCommAI() {
    let message = document.getElementById("commInput").value.trim();
    if (!message) return;

    addCommMsg(message, "user");
    document.getElementById("commInput").value = "";

    fetch("{{ url_for('loan_officer.communication_ai', borrower_id=borrower.id) }}", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ message })
    })
    .then(r => r.json())
    .then(data => {
        addCommMsg(formatAIResponse(data.reply), "ai");

        if (data.auto_tasks.length > 0) {
            addCommMsg(
                "AI created tasks:<br>â€¢ " + data.auto_tasks.join("<br>â€¢ "),
                "ai"
        if (data.auto_tasks.length > 0) {
            addFollowupMsg("AI created tasks:<br>â€¢ " + data.auto_tasks.join("<br>â€¢ "), "ai");
}

            );
        }
    });
}

/* Add copy buttons to AI output */
function formatAIResponse(text) {
    return `
        <div>
            <button class="copy-btn" onclick="copyText('call')">Copy Call</button>
            <button class="copy-btn" onclick="copyText('sms')">Copy SMS</button>
            <button class="copy-btn" onclick="copyText('email')">Copy Email</button>
        </div>
        <br>
        ${text.replace(/\n/g, "<br>")}
    `;
}

/* Copy to clipboard */
function copyText(type) {
    let msg = document.querySelector("#commMessages").innerText;

    let extract = "";

    if (type === "call") {
        extract = msg.split("CALL SCRIPT:")[1]?.split("SMS:")[0] || "";
    } else if (type === "sms") {
        extract = msg.split("SMS:")[1]?.split("EMAIL SUBJECT:")[0] || "";
    } else if (type === "email") {
        extract = msg.split("EMAIL SUBJECT:")[1] || "";
    }

    navigator.clipboard.writeText(extract.trim());
    alert(type.toUpperCase() + " copied!");
}
</script>
socket.on("doc_popup", function(data){
    let popup = document.getElementById("docPopup");
    let textElement = document.getElementById("docPopupText");
    let buttonContainer = document.getElementById("docPopupButtons");

    popup.classList.remove("hidden");

    textElement.innerText = 
        "Borrower mentioned: '" + data.original_text + "'";

    buttonContainer.innerHTML = "";

    data.docs.forEach(doc => {
        let btn = document.createElement("button");
        btn.innerText = "Request " + doc.replace("_", " ").toUpperCase();
        btn.onclick = () => requestDocument(doc, data.borrower_id);
        buttonContainer.appendChild(btn);
    });
});

function closeDocPopup(){
    document.getElementById("docPopup").classList.add("hidden");
}

function requestDocument(docName, borrower_id){
    fetch("/loan_officer/request-doc", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            doc_name: docName,
            borrower_id: borrower_id
        })
    })
    .then(r => r.json())
    .then(() => {
        alert("ðŸ“„ Document Request Added: " + docName.toUpperCase());
        closeDocPopup();
    });
}

{% endblock %}
