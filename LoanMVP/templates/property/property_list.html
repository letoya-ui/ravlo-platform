{% extends "layouts/base.html" %}
{% block content %}
<style>
  :root{--line:#2a2e36; --panel:#15161a; --text:#e6e6e6; --muted:#a5a7ad}
  .card{background:var(--panel); border:1px solid var(--line); border-radius:14px; padding:1rem}
  table{width:100%; border-collapse:collapse}
  th,td{padding:.6rem; border-top:1px solid var(--line); color:var(--text)}
  input{background:#0f0f11; border:1px solid var(--line); color:var(--text); border-radius:10px; padding:.45rem .6rem; width:100%}
  .btn{display:inline-flex; align-items:center; gap:.5rem; padding:.6rem .9rem; border-radius:10px; border:1px solid var(--line); color:var(--text); text-decoration:none; background:#1a1d23}
</style>
<div class="container-fluid dashboard-content text-light" style="margin-left:260px;">
  <h2 class="mb-4">ğŸ˜ï¸ Property List</h2>
  <p class="text-muted mb-4">Manage all borrower properties in one place. Add, edit, or remove properties instantly.</p>

  <!-- Add New Property -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <form method="GET" class="d-flex" id="searchForm">
      <input type="text" id="searchBox" placeholder="Search properties..." 
             class="form-control bg-dark text-light border-secondary me-2" style="width:300px;">
    </form>
    <a href="{{ url_for('admin.new_property') }}" class="btn btn-outline-light">
      â• Add Property
    </a>
  </div>

  <!-- Property Table -->
  <div class="card bg-dark border-secondary shadow-sm">
    <div class="card-header border-secondary d-flex justify-content-between align-items-center">
      <h5 class="mb-0">ğŸ  Properties Overview</h5>
      <button class="btn btn-sm btn-outline-light" onclick="refreshProperties()">ğŸ”„ Refresh</button>
    </div>
    <div class="card-body p-0">
      <table class="table table-dark table-hover align-middle mb-0" id="propertyTable">
        <thead class="table-secondary text-dark">
          <tr>
            <th>ID</th>
            <th>Address</th>
            <th>Value ($)</th>
            <th>Status</th>
            <th>Created</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for p in properties %}
          <tr>
            <td>{{ p.id }}</td>
            <td>{{ p.address }}</td>
            <td>${{ "{:,.2f}".format(p.value or 0) }}</td>
            <td>
              {% if p.status == 'active' %}
                <span class="badge bg-success">Active</span>
              {% elif p.status == 'pending' %}
                <span class="badge bg-warning text-dark">Pending</span>
              {% else %}
                <span class="badge bg-secondary">N/A</span>
              {% endif %}
            </td>
            <td>{{ p.created_at.strftime('%b %d, %Y') if p.created_at else 'â€”' }}</td>
            <td>
              <a href="{{ url_for('admin.edit_property', property_id=p.id) }}" class="btn btn-sm btn-outline-light">âœï¸ Edit</a>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteProperty({{ p.id }})">ğŸ—‘ï¸ Delete</button>
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="6" class="text-center text-muted py-4">No properties found.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- AJAX Refresh + Search -->
<script>
function refreshProperties() {
  fetch("{{ url_for('admin.property_list') }}", { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
    .then(response => response.text())
    .then(html => {
      const parser = new DOMParser();
      const newTable = parser.parseFromString(html, "text/html").querySelector("#propertyTable tbody");
      document.querySelector("#propertyTable tbody").innerHTML = newTable.innerHTML;
    });
}

function deleteProperty(id) {
  if (confirm("Are you sure you want to delete this property?")) {
    fetch(`/admin/property/delete/${id}`, { method: "POST" })
      .then(res => location.reload());
  }
}

document.getElementById('searchBox').addEventListener('keyup', function() {
  const filter = this.value.toLowerCase();
  document.querySelectorAll('#propertyTable tbody tr').forEach(row => {
    const text = row.textContent.toLowerCase();
    row.style.display = text.includes(filter) ? '' : 'none';
  });
});
</script>

<style>
.table th, .table td { vertical-align: middle !important; }
.card:hover { border-color: #777; transition: 0.3s ease; }
.badge { font-size: 0.85rem; padding: 0.4em 0.7em; }
</style>

{% endblock %}
