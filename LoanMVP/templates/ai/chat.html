{% extends "layouts/base.html" %}
{% block title %}AI Assistant | LoanMVP{% endblock %}
{% block content %}

<main style="margin-left:260px; padding:2rem; background:#0f0f11; color:#e6e6e6; min-height:100vh;">
  <link rel="stylesheet" href="https://unpkg.com/lucide-static@latest/font/lucide.css">

  <style>
    .chat-wrap {
      display:flex; flex-direction:column; max-width:880px; margin:auto;
      background:#15161a; border:1px solid #282b31; border-radius:16px;
      box-shadow:0 0 18px rgba(122,184,255,0.25);
      height:80vh; overflow:hidden;
    }
    .chat-header {
      display:flex; align-items:center; justify-content:space-between;
      padding:1rem 1.4rem; border-bottom:1px solid #282b31; background:#1b1d22;
    }
    .chat-header h2 { margin:0; font-size:1.1rem; color:#7ab8ff; display:flex; align-items:center; gap:.5rem; }
    .chat-header small { color:#a5a7ad; font-size:.8rem; }

    .preset-bar {
      display:flex; gap:.5rem; flex-wrap:wrap; padding:.9rem 1.4rem;
      background:#1a1c20; border-bottom:1px solid #282b31;
    }
    .chip {
      background:#1e2430; border:1px solid #2b2f36; color:#c4d9f2;
      padding:.4rem .7rem; border-radius:999px; font-size:.8rem; cursor:pointer;
      transition:all .2s ease;
    }
    .chip:hover { box-shadow:0 0 12px rgba(122,184,255,0.25); }

    .chat-body {
      flex:1; overflow-y:auto; padding:1.2rem;
      display:flex; flex-direction:column; gap:.8rem;
      scrollbar-width:thin; scrollbar-color:#7ab8ff #0f0f11;
    }
    .chat-msg {
      max-width:80%; padding:.8rem 1rem; border-radius:12px;
      font-size:.95rem; line-height:1.4;
      box-shadow:0 0 12px rgba(122,184,255,0.15);
    }
    .chat-msg.user {
      align-self:flex-end; background:#1f2933; color:#d7e8ff; border:1px solid #2b2f36;
    }
    .chat-msg.ai {
      align-self:flex-start; background:#18222b; border:1px solid #2b2f36; color:#bcd8ff;
    }

    .chat-input {
      display:flex; gap:.6rem; border-top:1px solid #282b31;
      background:#15161a; padding:1rem 1.2rem;
    }
    .chat-input input {
      flex:1; background:#0f0f11; border:1px solid #2b2f36; color:#e6e6e6;
      border-radius:10px; padding:.7rem .9rem;
    }
    .btn {
      display:inline-flex; align-items:center; justify-content:center;
      background:linear-gradient(180deg,#2a4a62,#1b2a38);
      border:1px solid #2a4a62; color:#cfe8ff;
      border-radius:10px; padding:.65rem .9rem; cursor:pointer;
      transition:all .2s ease;
    }
    .btn:hover { box-shadow:0 0 12px rgba(122,184,255,0.3); }
  </style>

  {% set role = (current_user.role|lower) if current_user else "general" %}
  <div class="chat-wrap">
    <div class="chat-header">
      <h2><i class="lucide lucide-message-circle"></i> 
        {% if role in ["borrower", "crm", "property"] %}CM Assistant{% else %}AI Assistant{% endif %}
      </h2>
      <small>
        {% if role in ["borrower", "crm", "property"] %}
          Smart chat for leads, homes & property insights
        {% else %}
          Ask about loans, workflows & borrower data
        {% endif %}
      </small>
    </div>

    {% if role not in ["borrower", "crm", "property"] %}
    <div class="preset-bar">
      <span class="chip" onclick="aiAsk('Summarize borrower eligibility')">Eligibility</span>
      <span class="chip" onclick="aiAsk('Show predictive loan trends')">Predictive Trends</span>
      <span class="chip" onclick="aiAsk('Generate workflow for loan review')">Workflow Plan</span>
      <span class="chip" onclick="aiAsk('Explain borrower credit profile impact')">Credit Impact</span>
      <span class="chip" onclick="aiAsk('Show AI memory usage summary')">Memory Summary</span>
    </div>
    {% endif %}

    <div class="chat-body" id="chatBody">
      <div class="chat-msg ai">
        {% if role in ["borrower", "crm", "property"] %}
          üëã Hi {{ current_user.first_name if current_user else 'there' }}! I'm your CM Assistant.  
          Ask me about your properties, CRM leads, or loan updates.
        {% else %}
          üëã Hello {{ current_user.username or 'User' }}! I‚Äôm your AI Assistant ‚Äî how can I help you today?
        {% endif %}
      </div>
    </div>

    <form class="chat-input" onsubmit="sendMessage(event)">
      <input id="chatInput" name="query" placeholder="Type your message..." autocomplete="off" />
      <button type="submit" class="btn"><i class="lucide lucide-send"></i></button>
    </form>
  </div>

  <script>
    const chatBody = document.getElementById('chatBody');
    async function sendMessage(e) {
      e.preventDefault();
      const input = document.getElementById('chatInput');
      const text = input.value.trim();
      if (!text) return;

      appendMessage('user', text);
      input.value = '';
      try {
        const res = await fetch("{{ url_for('ai.chat') }}", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({ message: text, context: "{{ role }}" })
        });
        const data = await res.json();
        appendMessage('ai', data.reply || "ü§ñ (No response)");
      } catch (err) {
        appendMessage('ai', "‚ö†Ô∏è Connection error ‚Äî please try again.");
      }
    }

    function aiAsk(q) {
      document.getElementById('chatInput').value = q;
      sendMessage(new Event('submit'));
    }

    function appendMessage(role, text) {
      const div = document.createElement('div');
      div.className = 'chat-msg ' + role;
      div.textContent = text;
      chatBody.appendChild(div);
      chatBody.scrollTop = chatBody.scrollHeight;
    }
  </script>
</main>
{% endblock %}
