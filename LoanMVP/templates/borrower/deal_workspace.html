{% extends "layouts/borrower_base.html" %}
{% block content %}

{# ---------- Helpers ---------- #}
{% macro money(val) -%}
  {%- if val is not none and val is not undefined -%}
    ${{ "{:,.0f}".format(val|float) }}
  {%- else -%}
    ‚Äî
  {%- endif -%}
{%- endmacro %}

{% macro money_mo(val) -%}
  {%- if val is not none and val is not undefined -%}
    ${{ "{:,.0f}".format(val|float) }}/mo
  {%- else -%}
    ‚Äî
  {%- endif -%}
{%- endmacro %}

{% set comps = comps or {} %}

<div class="dashboard-container">

<style>
  .dw-layout {
    display: grid;
    grid-template-columns: 2.1fr 1.4fr;
    gap: 1.5rem;
    margin-top: 1.5rem;
  }
  .dw-card {
    background: #0b1016;
    border-radius: 12px;
    padding: 1.25rem 1.5rem;
    border: 1px solid var(--line);
    box-shadow: 0 0 18px rgba(0,0,0,0.45);
  }
  .dw-card h3 { color: var(--accent); margin-bottom: .75rem; }
  .dw-label {
    display: block;
    margin-top: .75rem;
    margin-bottom: .25rem;
    font-size: .9rem;
    color: var(--text-light);
  }
  .dw-input {
    width: 100%;
    padding: .55rem .7rem;
    border-radius: 8px;
    border: 1px solid var(--line);
    background: #0f141a;
    color: var(--text);
    font-size: .9rem;
  }
  .dw-row {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: .75rem 1rem;
  }
  .dw-button {
    background: rgba(122,184,255,0.12);
    border: 1px solid rgba(122,184,255,0.45);
    color: #7ab8ff;
    padding: .7rem 1.2rem;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: .2s;
    font-size: .9rem;
    letter-spacing: .3px;
  }
  .dw-button:hover {
    background: rgba(122,184,255,0.22);
    border-color: #7ab8ff;
    box-shadow: 0 0 12px rgba(122,184,255,0.45);
  }

  .intelligence-grid {
    display: grid;
    grid-template-columns: 1fr 1fr 1.3fr;
    gap: 1.5rem;
    margin-top: 1.5rem;
  }
  .photo-carousel img {
    width: 100%;
    border-radius: 8px;
    margin-bottom: .5rem;
  }

  /* Rehab planner */
  .rehab-visual-grid{
    display:grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: .9rem;
    margin-top: .75rem;
  }
  .rehab-visual-item{
    border: 1px solid rgba(255,255,255,.08);
    border-radius: 10px;
    padding: .75rem;
    background: rgba(255,255,255,.02);
  }
  .rehab-visual-item h4{ margin:0 0 .5rem; color: var(--text-light); }
  .rehab-options{
    display:flex;
    gap:.5rem;
    flex-wrap:wrap;
  }
  .rehab-tag{
    display:inline-block;
    padding:.25rem .5rem;
    border-radius:999px;
    border:1px solid rgba(122,184,255,.35);
    background: rgba(122,184,255,.08);
    color:#cfe4ff;
    font-size:.8rem;
    margin-left:.35rem;
  }

  /* Modals */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.65);
    display: none;
    align-items: center;
    justify-content: center;
    padding: 1rem;
    z-index: 9999;
  }
  .modal-content {
    width: min(980px, 100%);
    background: #0b1016;
    border: 1px solid var(--line);
    border-radius: 12px;
    padding: 1.25rem;
    box-shadow: 0 0 24px rgba(0,0,0,0.6);
  }
  .style-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-top: .75rem;
  }
  .style-results-grid {
    display: grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap: .75rem;
    margin-top: .75rem;
  }
</style>

<div class="page-header">
  <h2>Borrower Deal Workspace</h2>
  <p class="text-muted">Analyze Flip, Rental, and Airbnb strategies with comps, rehab, and AI guidance.</p>
</div>

{# =========================
   PROPERTY PICKER (GET)
========================= #}
<div class="dw-card" style="margin-bottom:1rem;">
  <h3>üè† Select a Saved Property</h3>

  <form method="GET" action="{{ url_for('borrower.deal_workspace') }}">
    <label class="dw-label">Saved Properties</label>
    <select name="prop_id" class="dw-input" onchange="this.form.submit()">
      <option value="">‚Äî Choose a property ‚Äî</option>
      {% for p in saved_props %}
        <option value="{{ p.id }}" {% if selected_prop and selected_prop.id == p.id %}selected{% endif %}>
          {{ p.address }}{% if p.price %} ‚Äî ${{ "{:,.0f}".format(p.price|float) }}{% endif %}
        </option>
      {% endfor %}
    </select>

    <div style="margin-top:.75rem; display:flex; gap:.5rem; flex-wrap:wrap;">
      <button type="submit" class="dw-button">Load Property</button>
      <a href="{{ url_for('borrower.saved_properties') }}" class="dw-button" style="text-decoration:none;">
        View Saved Properties
      </a>
    </div>
  </form>
</div>

{% if not selected_prop %}
  <div class="dw-card">
    <p class="ai-text">Select a saved property to load comps and run strategy analysis.</p>
  </div>
{% else %}

{# =========================
   MAIN ANALYSIS FORM (POST)
========================= #}
<form method="POST" action="{{ url_for('borrower.deal_workspace', prop_id=selected_prop.id) }}">
  {{ csrf_token() if csrf_token is defined }}
  <input type="hidden" name="prop_id" value="{{ selected_prop.id }}">

  <!-- DEAL SETUP -->
  <div class="dw-card">
    <h3>üè† Deal Setup</h3>

    <div class="dw-row">
      <div>
        <label class="dw-label">Strategy</label>
        <select name="mode" class="dw-input" onchange="this.form.submit()">
          <option value="flip" {% if mode == 'flip' %}selected{% endif %}>Flip</option>
          <option value="rental" {% if mode == 'rental' %}selected{% endif %}>Rental</option>
          <option value="airbnb" {% if mode == 'airbnb' %}selected{% endif %}>Airbnb</option>
        </select>
      </div>

      <div>
        <label class="dw-label">Property</label>
        <input type="text" class="dw-input" value="{{ selected_prop.address }}" readonly>
      </div>
    </div>

    <div style="margin-top:1rem;">
      <button type="submit" class="dw-button">Run Analysis</button>
    </div>
  </div>

  {# =========================
     PROPERTY INTELLIGENCE GRID
  ========================= #}
  {% if resolved %}
  <div class="intelligence-grid">

    <!-- 1) Property Summary -->
    <div class="dw-card">
      <h3>üè° Property Summary</h3>
      {% if resolved.property %}
        <p class="ai-text">
          <strong>{{ resolved.property.address }}</strong><br>
          {{ resolved.property.city }}, {{ resolved.property.state }} {{ resolved.property.zip }}<br><br>
          <strong>Beds:</strong> {{ resolved.property.beds or '‚Äî' }}<br>
          <strong>Baths:</strong> {{ resolved.property.baths or '‚Äî' }}<br>
          <strong>Sqft:</strong> {{ resolved.property.sqft or '‚Äî' }}<br>
          <strong>Year Built:</strong> {{ resolved.property.year_built or '‚Äî' }}<br>
          <strong>Type:</strong> {{ resolved.property.property_type or '‚Äî' }}
        </p>
      {% else %}
        <p class="ai-text">No property data available.</p>
      {% endif %}
    </div>

    <!-- 2) Valuation + Rent -->
    <div class="dw-card">
      <h3>üìà Valuation + Rent</h3>

      {# valuation #}
      {% set v = resolved.property.valuation if resolved and resolved.property and resolved.property.valuation is not undefined else none %}
      {% set v_value = (v.get('value') if v is mapping else (v.value if v else none)) %}
      {% set v_low   = (v.get('low')   if v is mapping else (v.low   if v else none)) %}
      {% set v_high  = (v.get('high')  if v is mapping else (v.high  if v else none)) %}
      {% set v_conf  = (v.get('confidence') if v is mapping else (v.confidence if v else none)) %}

      <div class="ai-text" style="margin-bottom:1rem;">
        <strong>Value:</strong> {{ money(v_value) }}<br>
        <strong>Range:</strong>
        {% if v_low is not none and v_high is not none %}
          {{ money(v_low) }} ‚Äì {{ money(v_high) }}
        {% else %}
          ‚Äî
        {% endif %}
        <br>
        <strong>Confidence:</strong> {{ v_conf or '‚Äî' }}
      </div>

      {# rent #}
      {% set r = resolved.property.rent_estimate if resolved and resolved.property and resolved.property.rent_estimate is not undefined else none %}
      {% set r_value = (r.get('value') if r is mapping else (r.value if r else none)) %}
      {% set r_low   = (r.get('low')   if r is mapping else (r.low   if r else none)) %}
      {% set r_high  = (r.get('high')  if r is mapping else (r.high  if r else none)) %}
      {% set r_conf  = (r.get('confidence') if r is mapping else (r.confidence if r else none)) %}

      <div class="ai-text">
        <strong>Rent:</strong> {{ money_mo(r_value) }}<br>
        <strong>Range:</strong>
        {% if r_low is not none and r_high is not none %}
          {{ money_mo(r_low) }} ‚Äì {{ money_mo(r_high) }}
        {% else %}
          ‚Äî
        {% endif %}
        <br>
        <strong>Confidence:</strong> {{ r_conf or '‚Äî' }}
      </div>
    </div>

    <!-- 3) Renovation Studio -->
    <div class="dw-card">
      <h3>üèóÔ∏è Renovation Studio</h3>
      <p class="ai-text" style="margin-top:-.25rem;">
        Upload a room photo or pick a property photo. Generate HGTV-style after images + plan scope.
      </p>

      <div style="display:flex; gap:.5rem; flex-wrap:wrap; margin:.75rem 0 1rem;">
        <label class="dw-button" style="cursor:pointer;">
          üì∑ Upload Room Photo
          <input type="file" id="uploadRoomPhoto" accept="image/*" style="display:none;">
        </label>

        <button type="button" class="dw-button" onclick="openStyleModal(null)">‚ú® Open Visualizer</button>
        <button type="button" class="dw-button" onclick="openRehabPreview()">üëÄ Rehab Preview</button>
      </div>

      {% if resolved.property and resolved.property.photos %}
        <div class="photo-carousel">
          {% for photo in resolved.property.photos %}
            <div style="margin-bottom:.9rem;">
              <img src="{{ photo }}" alt="Property photo" style="width:100%; border-radius:10px; margin-bottom:.45rem;">
              <div style="display:flex; gap:.5rem; flex-wrap:wrap;">
                <button type="button" class="dw-button" onclick="setVisualizerSourceUrl('{{ photo }}')">‚úÖ Use as Before</button>
                <button type="button" class="dw-button" onclick="openStyleModal('{{ photo }}')">‚ú® Reimagine</button>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="ai-text">No property photos found. Upload a room photo to start.</p>
      {% endif %}

      {% if mode == "flip" %}
      <hr style="border:none; border-top:1px solid rgba(255,255,255,.08); margin:1rem 0;">

      <h4 style="color:var(--accent); margin:0 0 .6rem;">üì¶ Rehab Templates</h4>
      <select id="rehab-template" class="dw-input" onchange="applyRehabTemplate()">
        <option value="">Select a template...</option>
        <option value="rental">Rental-Ready</option>
        <option value="flip">Flip-Ready</option>
        <option value="airbnb">Airbnb-Ready</option>
        <option value="luxury">Luxury Upgrade</option>
        <option value="budget">Budget Rehab</option>
      </select>

      <div style="margin-top:1rem;">
        <h4 style="color:var(--accent); margin:0 0 .6rem;">üè° Rehab Visual Planner</h4>

        <label class="dw-label">Scope</label>
        <select name="rehab_scope" class="dw-input">
          <option value="light" {% if request.form.rehab_scope == 'light' %}selected{% endif %}>Light</option>
          <option value="medium" {% if request.form.rehab_scope in ['', None, 'medium'] %}selected{% endif %}>Medium</option>
          <option value="heavy" {% if request.form.rehab_scope == 'heavy' %}selected{% endif %}>Heavy</option>
        </select>

        <div class="rehab-visual-grid">
          <div class="rehab-visual-item">
            <h4>Kitchen</h4>
            <div class="rehab-options">
              <label><input type="radio" name="kitchen" value="light" {% if request.form.kitchen == 'light' %}checked{% endif %}><span class="rehab-tag">Light</span></label>
              <label><input type="radio" name="kitchen" value="medium" {% if request.form.kitchen == 'medium' %}checked{% endif %}><span class="rehab-tag">Medium</span></label>
              <label><input type="radio" name="kitchen" value="heavy" {% if request.form.kitchen == 'heavy' %}checked{% endif %}><span class="rehab-tag">Full Gut</span></label>
            </div>
          </div>

          <div class="rehab-visual-item">
            <h4>Bathroom</h4>
            <div class="rehab-options">
              <label><input type="radio" name="bathroom" value="light" {% if request.form.bathroom == 'light' %}checked{% endif %}><span class="rehab-tag">Light</span></label>
              <label><input type="radio" name="bathroom" value="medium" {% if request.form.bathroom == 'medium' %}checked{% endif %}><span class="rehab-tag">Medium</span></label>
              <label><input type="radio" name="bathroom" value="heavy" {% if request.form.bathroom == 'heavy' %}checked{% endif %}><span class="rehab-tag">Full Gut</span></label>
            </div>
          </div>

          <div class="rehab-visual-item">
            <h4>Flooring</h4>
            <div class="rehab-options">
              <label><input type="radio" name="flooring" value="light" {% if request.form.flooring == 'light' %}checked{% endif %}><span class="rehab-tag">Carpet</span></label>
              <label><input type="radio" name="flooring" value="medium" {% if request.form.flooring == 'medium' %}checked{% endif %}><span class="rehab-tag">Vinyl</span></label>
              <label><input type="radio" name="flooring" value="heavy" {% if request.form.flooring == 'heavy' %}checked{% endif %}><span class="rehab-tag">Hardwood</span></label>
            </div>
          </div>

          <div class="rehab-visual-item">
            <h4>Paint</h4>
            <div class="rehab-options">
              <label><input type="radio" name="paint" value="light" {% if request.form.paint == 'light' %}checked{% endif %}><span class="rehab-tag">Touch-up</span></label>
              <label><input type="radio" name="paint" value="medium" {% if request.form.paint == 'medium' %}checked{% endif %}><span class="rehab-tag">Full Interior</span></label>
              <label><input type="radio" name="paint" value="heavy" {% if request.form.paint == 'heavy' %}checked{% endif %}><span class="rehab-tag">Interior + Exterior</span></label>
            </div>
          </div>
        </div>
      </div>
      {% endif %}
    </div>

  </div>
  {% endif %}

  <!-- LEFT + RIGHT LAYOUT -->
  <div class="dw-layout">

    <!-- LEFT COLUMN -->
    <div>

      {% if mode == "flip" %}
      <div class="dw-card" style="margin-top:1.5rem;">
        <h3>üìä Flip Inputs</h3>
        <div class="dw-row">
          <div>
            <label class="dw-label">Purchase Price</label>
            <input type="number" name="purchase_price" class="dw-input"
                   value="{{ request.form.purchase_price or comps.get('property', {}).get('price', '') }}">
          </div>
          <div>
            <label class="dw-label">ARV</label>
            <input type="number" name="arv" class="dw-input"
                   value="{{ request.form.arv or comps.get('arv_estimate', '') }}">
          </div>
          <div>
            <label class="dw-label">Holding Months</label>
            <input type="number" name="holding_months" class="dw-input"
                   value="{{ request.form.holding_months or 6 }}">
          </div>
          <div>
            <label class="dw-label">Monthly Holding Cost</label>
            <input type="number" name="monthly_holding_cost" class="dw-input"
                   value="{{ request.form.monthly_holding_cost or '' }}" placeholder="Optional">
          </div>
        </div>

        <div class="dw-row" style="margin-top:.5rem;">
          <div>
            <label class="dw-label">Selling Cost Rate (0.08 = 8%)</label>
            <input type="number" step="0.01" name="selling_cost_rate" class="dw-input"
                   value="{{ request.form.selling_cost_rate or 0.08 }}">
          </div>
          <div>
            <label class="dw-label">Down Payment Rate (0.20 = 20%)</label>
            <input type="number" step="0.01" name="down_payment_rate" class="dw-input"
                   value="{{ request.form.down_payment_rate or 0.20 }}">
          </div>
        </div>
      </div>

      {% elif mode == "rental" %}
      <div class="dw-card" style="margin-top:1.5rem;">
        <h3>üè¢ Rental Inputs</h3>
        <div class="dw-row">
          <div>
            <label class="dw-label">Purchase Price</label>
            <input type="number" name="purchase_price" class="dw-input"
                   value="{{ request.form.purchase_price or comps.get('property', {}).get('price', '') }}">
          </div>
          <div>
            <label class="dw-label">Monthly Rent</label>
            <input type="number" name="monthly_rent" class="dw-input"
                   value="{{ request.form.monthly_rent or comps.get('market_rent_estimate', '') }}">
          </div>
          <div>
            <label class="dw-label">Monthly Taxes</label>
            <input type="number" name="monthly_taxes" class="dw-input"
                   value="{{ request.form.monthly_taxes or '' }}" placeholder="Optional">
          </div>
          <div>
            <label class="dw-label">Monthly Insurance</label>
            <input type="number" name="monthly_insurance" class="dw-input"
                   value="{{ request.form.monthly_insurance or '' }}" placeholder="Optional">
          </div>
        </div>

        <div class="dw-row" style="margin-top:.5rem;">
          <div>
            <label class="dw-label">Down Payment Rate (0.25 = 25%)</label>
            <input type="number" step="0.01" name="down_payment_rate" class="dw-input"
                   value="{{ request.form.down_payment_rate or 0.25 }}">
          </div>
          <div>
            <label class="dw-label">Interest Rate (0.075 = 7.5%)</label>
            <input type="number" step="0.001" name="interest_rate" class="dw-input"
                   value="{{ request.form.interest_rate or 0.075 }}">
          </div>
        </div>
      </div>

      {% elif mode == "airbnb" %}
      <div class="dw-card" style="margin-top:1.5rem;">
        <h3>üåô STR / Airbnb Inputs</h3>
        <div class="dw-row">
          <div>
            <label class="dw-label">Purchase Price</label>
            <input type="number" name="purchase_price" class="dw-input"
                   value="{{ request.form.purchase_price or comps.get('property', {}).get('price', '') }}">
          </div>
          <div>
            <label class="dw-label">Nightly Rate</label>
            <input type="number" name="nightly_rate" class="dw-input"
                   value="{{ request.form.nightly_rate or comps.get('airbnb_rate_estimate', '') }}">
          </div>
          <div>
            <label class="dw-label">Occupancy Rate (0.55 = 55%)</label>
            <input type="number" step="0.01" name="occupancy_rate" class="dw-input"
                   value="{{ request.form.occupancy_rate or (comps.get('airbnb_occupancy_estimate', '') if comps else '') }}">
          </div>
          <div>
            <label class="dw-label">Cleaning Cost per Stay</label>
            <input type="number" name="cleaning_fee_cost" class="dw-input"
                   value="{{ request.form.cleaning_fee_cost or '' }}">
          </div>
        </div>
      </div>
      {% endif %}

      <!-- OPTIMIZATION BUTTONS -->
      <div style="margin-top:1rem;">
        <button type="submit" name="action" value="optimize_roi" class="dw-button" style="margin-top:.75rem;">
          üìà Optimize for Highest ROI
        </button>

        <button type="submit" name="action" value="optimize_timeline" class="dw-button" style="margin-top:.75rem;">
          ‚è±Ô∏è Optimize for Fastest Timeline
        </button>

        <button type="submit" name="action" value="optimize_arv" class="dw-button" style="margin-top:.75rem;">
          üè° Optimize for Highest ARV Impact
        </button>
      </div>

      <div style="margin-top:1rem;">
        <label class="dw-label">Target Rehab Budget</label>
        <input type="number" name="target_rehab_budget" class="dw-input"
               placeholder="Enter target budget (optional)"
               value="{{ request.form.target_rehab_budget or '' }}">

        <button type="submit" name="action" value="optimize_rehab" class="dw-button" style="margin-top:.75rem;">
          üéØ Optimize Rehab to Fit Budget
        </button>
      </div>

      <!-- RESULTS -->
      {% if results %}
      <div class="dw-card" style="margin-top:1.5rem;">
        <h3>üìà Deal Results</h3>
        <p class="ai-text">
          {% if results.profit is defined %}<strong>Profit (Flip):</strong> ${{ "{:,.0f}".format(results.profit|float) }}<br>{% endif %}
          {% if results.net_cashflow is defined %}<strong>Monthly Cash Flow (Rental):</strong> ${{ "{:,.0f}".format(results.net_cashflow|float) }}<br>{% endif %}
          {% if results.net_monthly is defined %}<strong>Net Monthly (Airbnb):</strong> ${{ "{:,.0f}".format(results.net_monthly|float) }}<br>{% endif %}
          {% if results.roi is defined and results.roi %}<strong>ROI:</strong> {{ "{:,.1f}".format(results.roi * 100) }}%{% endif %}
        </p>
      </div>

      <!-- SAVE / SEND / EXPORT -->
      <div class="dw-card" style="margin-top:1.5rem; text-align:right;">
        <input type="hidden" name="property_id" value="{{ property_id or selected_prop.id }}">
        <input type="hidden" name="mode" value="{{ mode or '' }}">
        <input type="hidden" name="results_json" value="{{ results | tojson if results else '{}' }}">
        <input type="hidden" name="comps_json" value="{{ comps | tojson if comps else '{}' }}">
        <input type="hidden" name="resolved_json" value="{{ resolved | tojson if resolved else '{}' }}">

        <button type="submit" class="dw-button" formaction="{{ url_for('borrower.save_deal') }}" formmethod="POST">
          üíæ Save Deal
        </button>

        <button type="submit" class="dw-button" formaction="{{ url_for('borrower.send_to_lo') }}" formmethod="POST">
          üì§ Send to Loan Officer
        </button>

        {% if deal_id %}
          <a href="{{ url_for('borrower.export_deal_report_pro', deal_id=deal_id) }}"><button type="button" class="dw-button">üìÑ Download Deal Report</button></a>
          <a href="{{ url_for('borrower.export_rehab_scope', deal_id=deal_id) }}"><button type="button" class="dw-button">üìÑ Download Rehab Scope</button></a>
        {% else %}
          <button type="button" class="dw-button" disabled>üìÑ Download Deal Report (Save Deal First)</button>
          <button type="button" class="dw-button" disabled>üìÑ Download Rehab Scope (Save Deal First)</button>
        {% endif %}
      </div>
      {% endif %}

    </div>

    <!-- RIGHT COLUMN -->
    <div>
      {% set placeholder = '<span class="placeholder">Not available at this time</span>' %}

      {% if comps %}
      <div class="dw-card">
        <h3>üìç Market Snapshot</h3>
        <p class="ai-text">
          {% if comps.market_snapshot %}
            <strong>Median Price:</strong>
            {% if comps.market_snapshot.median_price %}${{ "{:,.0f}".format(comps.market_snapshot.median_price|float) }}{% else %}{{ placeholder|safe }}{% endif %}
            <br>
            <strong>YoY Change:</strong>
            {% if comps.market_snapshot.yoy_change is not none %}{{ comps.market_snapshot.yoy_change }}%{% else %}{{ placeholder|safe }}{% endif %}
            <br>
            <strong>Days on Market:</strong>
            {% if comps.market_snapshot.days_on_market %}{{ comps.market_snapshot.days_on_market }}{% else %}{{ placeholder|safe }}{% endif %}
          {% else %}
            {{ placeholder|safe }}
          {% endif %}
        </p>
      </div>
      {% endif %}

      {% if comparison %}
      <div class="dw-card" style="margin-top:1.5rem;">
        <h3>üìò Strategy Summary</h3>
        <div class="ai-text">

          {% set prop = (resolved.property if resolved and resolved.property is not undefined else none) %}
          {% set v2 = (prop.valuation if prop and prop.valuation is not undefined else none) %}
          {% set arv_val = (v2.get('value') if v2 is mapping else (v2.value if v2 else none)) %}
          {% set r2 = (prop.rent_estimate if prop and prop.rent_estimate is not undefined else none) %}
          {% set rent_val = (r2.get('value') if r2 is mapping else (r2.value if r2 else none)) %}

          <h4 style="color:var(--accent); margin-top:.5rem;">Flip</h4>
          <p>
            <strong>Profit:</strong> {% if comparison.flip.profit is not none %}${{ "{:,.0f}".format(comparison.flip.profit|float) }}{% else %}{{ placeholder|safe }}{% endif %}<br>
            <strong>ROI:</strong> {% if comparison.flip.roi %}{{ "{:,.1f}".format(comparison.flip.roi * 100) }}%{% else %}{{ placeholder|safe }}{% endif %}<br>
            <strong>ARV:</strong> {% if arv_val is not none %}${{ "{:,.0f}".format(arv_val|float) }}{% else %}{{ placeholder|safe }}{% endif %}
          </p>

          <h4 style="color:var(--accent); margin-top:1rem;">Rental</h4>
          <p>
            <strong>Cash Flow:</strong> {% if comparison.rental.net_cashflow is not none %}${{ "{:,.0f}".format(comparison.rental.net_cashflow|float) }}/mo{% else %}{{ placeholder|safe }}{% endif %}<br>
            <strong>DSCR:</strong> {% if comparison.rental.dscr %}{{ "{:,.2f}".format(comparison.rental.dscr|float) }}{% else %}{{ placeholder|safe }}{% endif %}<br>
            <strong>Rent Estimate:</strong> {% if rent_val is not none %}${{ "{:,.0f}".format(rent_val|float) }}/mo{% else %}{{ placeholder|safe }}{% endif %}
          </p>

          <h4 style="color:var(--accent); margin-top:1rem;">Airbnb</h4>
          <p>
            <strong>Net Monthly:</strong> {% if comparison.airbnb.net_monthly is not none %}${{ "{:,.0f}".format(comparison.airbnb.net_monthly|float) }}/mo{% else %}{{ placeholder|safe }}{% endif %}<br>
            <strong>Occupancy:</strong> {% if comparison.airbnb.occupancy %}{{ "{:,.0f}".format(comparison.airbnb.occupancy * 100) }}%{% else %}{{ placeholder|safe }}{% endif %}<br>
            <strong>Nightly Rate:</strong> {% if comparison.airbnb.nightly_rate %}${{ "{:,.0f}".format(comparison.airbnb.nightly_rate|float) }}{% else %}{{ placeholder|safe }}{% endif %}
          </p>

        </div>
      </div>
      {% endif %}

      {% if ai_summary %}
      <div class="dw-card" style="margin-top:1.5rem;">
        <h3>ü§ñ AI Deal Insights</h3>
        <p class="ai-text">{{ ai_summary }}</p>
      </div>
      {% endif %}
    </div>

  </div>

</form>

<!-- Rehab Preview Modal -->
<div id="rehabPreviewModal" class="modal-overlay">
  <div class="modal-content">
    <h3>Rehab Visual Preview</h3>

    <p><strong>Before:</strong></p>
    <p id="preview-before" class="preview-text"></p>

    <hr style="border-color: var(--line); margin: 1rem 0;">

    <p><strong>After (Based on Your Selections):</strong></p>
    <p id="preview-after" class="preview-text"></p>

    <button type="button" class="dw-button" onclick="closeRehabPreview()" style="margin-top:1rem;">Close</button>
  </div>
</div>

<!-- Style Modal -->
<div id="styleModal" class="modal-overlay">
  <div class="modal-content">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h3>‚ú® AI Renovation Visualizer</h3>
      <button type="button" class="dw-button" onclick="closeStyleModal()">Close</button>
    </div>

    <div class="style-grid">
      <div>
        <p class="dw-label">Before</p>
        <img id="styleBeforeImage" src="" style="width:100%; border-radius:8px;">
      </div>

      <div>
        <label class="dw-label">Style Prompt</label>
        <input id="stylePrompt" class="dw-input" placeholder="e.g., modern minimalist kitchen with matte black fixtures">
        <div style="display:flex; gap:.5rem; margin-top:.75rem; flex-wrap:wrap;">
          <button type="button" class="dw-button" onclick="setStylePreset('luxury')">Luxury</button>
          <button type="button" class="dw-button" onclick="setStylePreset('modern')">Modern</button>
          <button type="button" class="dw-button" onclick="setStylePreset('airbnb')">Airbnb</button>
          <button type="button" class="dw-button" onclick="setStylePreset('flip')">Flip</button>
          <button type="button" class="dw-button" onclick="setStylePreset('budget')">Budget</button>
        </div>

        <div class="dw-row" style="margin-top:1rem;">
          <div>
            <label class="dw-label">Variations</label>
            <select id="styleVariations" class="dw-input">
              <option value="1">1</option>
              <option value="2" selected>2</option>
              <option value="3">3</option>
              <option value="4">4</option>
            </select>
          </div>
          <div style="display:flex; align-items:end;">
            <label style="display:flex; gap:.5rem; align-items:center; margin-bottom:.2rem;">
              <input id="styleSaveToDeal" type="checkbox">
              <span class="dw-label" style="margin:0;">Save to deal</span>
            </label>
          </div>
        </div>

        <button type="button" class="dw-button" onclick="runStyleTransform()" style="margin-top:1rem; width:100%;">
          Generate Designs
        </button>

        <div id="styleCostEstimate" style="margin-top:.75rem;"></div>
      </div>
    </div>

    <div id="styleResults" style="display:none; margin-top:1rem;">
      <h4 style="color:var(--accent); margin:.25rem 0;">Results</h4>
      <div id="styleResultsGrid" class="style-results-grid"></div>
    </div>

    <div id="beforeAfterWrapper" style="display:none; margin-top:1rem;">
      <h4 style="color:var(--accent); margin:.25rem 0;">Before / After</h4>
      <div style="position:relative; width:100%; border-radius:8px; overflow:hidden;">
        <img id="baBefore" src="" style="width:100%; display:block;">
        <img id="baAfter" src="" style="width:100%; position:absolute; inset:0; clip-path: inset(0 50% 0 0);">
      </div>
      <input id="baSlider" type="range" min="0" max="100" value="50" style="width:100%; margin-top:.75rem;">
    </div>
  </div>
</div>

{% endif %}

<script>
/* ==========================
   Rehab templates
========================== */
function applyRehabTemplate() {
  const template = document.getElementById("rehab-template")?.value;
  const templates = {
    rental: { rehab_scope: "light", kitchen: "light", bathroom: "light", flooring: "medium", paint: "medium" },
    flip:   { rehab_scope: "medium", kitchen: "medium", bathroom: "medium", flooring: "medium", paint: "medium" },
    airbnb: { rehab_scope: "medium", kitchen: "medium", bathroom: "medium", flooring: "heavy",  paint: "medium" },
    luxury: { rehab_scope: "heavy",  kitchen: "heavy",  bathroom: "heavy",  flooring: "heavy",  paint: "heavy" },
    budget: { rehab_scope: "light",  kitchen: "",       bathroom: "",       flooring: "light",  paint: "light" }
  };
  if (!templates[template]) return;
  const config = templates[template];

  const scopeSel = document.querySelector('select[name="rehab_scope"]');
  if (scopeSel) scopeSel.value = config.rehab_scope;

  for (const key in config) {
    if (key === "rehab_scope") continue;
    const value = config[key];
    if (!value) continue;
    const input = document.querySelector(`input[name="${key}"][value="${value}"]`);
    if (input) input.checked = true;
  }
}

function openRehabPreview() {
  const items = {
    kitchen: document.querySelector('input[name="kitchen"]:checked')?.value,
    bathroom: document.querySelector('input[name="bathroom"]:checked')?.value,
    flooring: document.querySelector('input[name="flooring"]:checked')?.value,
    paint: document.querySelector('input[name="paint"]:checked')?.value
  };

  document.getElementById("preview-before").innerText =
    "Original property condition with dated finishes, worn surfaces, and standard builder-grade materials.";

  document.getElementById("preview-after").innerText =
    `Updated with ${items.kitchen || '‚Äî'} kitchen, ${items.bathroom || '‚Äî'} bathroom, ` +
    `${items.flooring || '‚Äî'} flooring, and ${items.paint || '‚Äî'} paint.`;

  document.getElementById("rehabPreviewModal").style.display = "flex";
}
function closeRehabPreview() {
  document.getElementById("rehabPreviewModal").style.display = "none";
}

/* ==========================
   Visualizer (file OR url)
========================== */
let _styleCurrentBefore = null;     // what we show in the modal (can be blob or url)
let _styleCurrentFile = null;       // upload file bytes (preferred)
let _styleCurrentUrl = null;        // property photo url (http/https)

document.getElementById("uploadRoomPhoto")?.addEventListener("change", (e) => {
  const file = e.target.files?.[0];
  if (!file) return;
  _styleCurrentFile = file;
  _styleCurrentUrl = null;

  const previewUrl = URL.createObjectURL(file);
  openStyleModal(previewUrl);
});

function setVisualizerSourceUrl(url) {
  _styleCurrentUrl = url;
  _styleCurrentFile = null;
  openStyleModal(url);
}

function openStyleModal(photoUrl) {
  _styleCurrentBefore = photoUrl || _styleCurrentBefore || null;

  document.getElementById("styleBeforeImage").src = _styleCurrentBefore || "";
  document.getElementById("styleModal").style.display = "flex";
  document.getElementById("styleResults").style.display = "none";
  document.getElementById("styleResultsGrid").innerHTML = "";
  document.getElementById("styleCostEstimate").innerHTML = "";
  document.getElementById("beforeAfterWrapper").style.display = "none";
}

function closeStyleModal() {
  document.getElementById("styleModal").style.display = "none";
}

function setStylePreset(preset) {
  const map = {
    luxury: "luxury high-end finishes, marble, designer lighting, spa-like feel",
    modern: "modern minimalist, clean lines, neutral palette, matte black fixtures",
    airbnb: "Airbnb-ready, cozy, Instagrammable, layered textures, warm lighting",
    flip: "flip-ready, durable mid-range finishes, bright, neutral, resale-friendly",
    budget: "budget-friendly, clean, simple, fresh paint, basic but appealing finishes",
  };
  document.getElementById("stylePrompt").value = map[preset] || "";
  document.getElementById("stylePrompt").dataset.preset = preset;
}

formData.append("saved_property_id", savedPropertyId);
function selectBeforeAfter(afterImg) {
  const wrapper = document.getElementById("beforeAfterWrapper");
  const before = document.getElementById("baBefore");
  const after = document.getElementById("baAfter");
  const slider = document.getElementById("baSlider");

  before.src = _styleCurrentBefore || "";
  after.src = afterImg || "";
  wrapper.style.display = "block";

  slider.value = 50;
  updateBeforeAfterClip(slider.value);

  slider.oninput = function() {
    updateBeforeAfterClip(this.value);
  };
}

function updateBeforeAfterClip(val) {
  const after = document.getElementById("baAfter");
  after.style.clipPath = `inset(0 ${100 - val}% 0 0)`;
}
</script>

</div>
{% endblock %}
