{% extends "layouts/borrower_base.html" %}
{% block title %}Messages{% endblock %}
{% block content %}

  </aside>

  <!-- MAIN CONTENT -->
  <main class="b-main">
    
    <!-- MESSENGER LAYOUT -->
    <div class="messenger-layout">

      <!-- Conversation List -->
      <aside class="conversation-list">
        <h2>Conversations</h2>
        {% for officer in officers %}
          <a href="{{ url_for('borrower.messages', receiver_id=officer.id) }}"
             class="conversation {% if selected_receiver == officer.id %}active{% endif %}">
            <div class="name">{{ officer.full_name or officer.username }}</div>
            <div class="last-msg">
              {{ officer.last_message.content[:30] if officer.last_message else 'No messages yet' }}
            </div>
          </a>
        {% endfor %}
      </aside>

      <!-- Conversation Window -->
      <div class="messages">
        {% if messages %}
          {% for msg in messages %}
            <div class="message {{ 'from-me' if msg.sender_id == current_user.id else 'from-them' }}">
              <div class="bubble">
                <p>{{ msg.content }}</p>
                <small class="timestamp">
                  {{ msg.created_at.strftime("%b %d, %Y %I:%M %p") }}
                  {% if msg.sender_id == current_user.id %}
                    ‚Ä¢ You
                  {% else %}
                    ‚Ä¢ {{ msg.sender.full_name or msg.sender.username }}
                  {% endif %}
                  {% if msg.is_read %} ‚Ä¢ Seen{% endif %}
                </small>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <p class="muted" style="text-align:center; margin-top:2rem;">No messages yet. Select a conversation üëà</p>
        {% endif %}
      </div>

    </div>

    <!-- Send Message Form -->
    {% if selected_receiver %}
    <form method="POST" action="{{ url_for('borrower.send_message') }}" class="chat-input" enctype="multipart/form-data">
      <input type="hidden" name="receiver_id" value="{{ selected_receiver }}">
      <input type="text" name="content" placeholder="Type a message..." required>
      <input type="file" name="attachment" class="file-upload">
      <button type="submit" class="btn-glow">Send</button>
    </form>
    {% endif %}

    <!-- AI Assistant Panel -->
    <div class="b-card" style="margin-top:2rem;">
      <h2>ü§ñ Ask LoanMVP AI</h2>
      <p class="muted">Ask your virtual assistant about your loan, documents, or project insights.</p>

      <form id="aiForm" method="POST" action="{{ url_for('borrower.ask_ai_post') }}">
        <input type="text" name="question" id="aiInput" placeholder="e.g., What‚Äôs the status of my loan?" required class="form-control">
        <button type="submit" class="action-btn" style="margin-top:.75rem;">Ask AI</button>
      </form>

      <div id="aiResponse" class="ai-response"></div>
    </div>

  </main>
</div>

<style>
/* Messenger Layout */
.messenger-layout { display: flex; height: 600px; border: 1px solid var(--line); border-radius: 12px; overflow: hidden; margin-top:1rem; }
.conversation-list { width: 280px; border-right: 1px solid var(--line); background: var(--panel); overflow-y: auto; }
.conversation { display: block; padding: 1rem; border-bottom: 1px solid var(--line); text-decoration: none; color: var(--text); }
.conversation.active { background: var(--hover); }
.messages { flex: 1; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column; gap: 1rem; }

/* Message Bubbles */
.message { display: flex; width: 100%; }
.from-me { justify-content: flex-end; }
.from-them { justify-content: flex-start; }
.bubble { max-width: 70%; padding: .9rem 1.2rem; border-radius: 18px; line-height: 1.5; font-size: 0.95rem; background: var(--hover); box-shadow: 0 0 12px rgba(0,0,0,0.35); }
.from-them .bubble { background: #1f2328; border: 1px solid var(--line); color: var(--text); border-bottom-left-radius: 4px; }
.from-me .bubble { background: var(--accent); color: #000; border-bottom-right-radius: 4px; box-shadow: 0 0 14px rgba(122,184,255,0.4); }
.timestamp { display: block; font-size: .75rem; opacity: 0.7; margin-top: .4rem; text-align: right; }

/* Chat Input */
.chat-input { display: flex; align-items: center; padding: 1rem; border-top: 1px solid var(--line); gap: .5rem; margin-top:1rem; }
.chat-input input[type="text"] { flex: 1; min-width: 250px; padding: .75rem; border-radius: 10px; border: 1px solid var(--line); background: var(--hover); color: var(--text); }
.file-upload { max-width: 180px; }

/* AI Panel */
.ai-response { margin-top: 1rem; padding: 1rem; background: var(--hover); border-radius: 10px; border-left: 4px solid var(--accent); display: none; }
</style>

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
  const socket = io();

  socket.emit("join", { room: "user_{{ current_user.id }}" });

  socket.on("new_message", (data) => {
    const messagesDiv = document.querySelector(".messages");
    const bubble = document.createElement("div");
    bubble.className = "message " + (data.sender_id == {{ current_user.id }} ? "from-me" : "from-them");
    bubble.innerHTML = `
      <div class="bubble">
        <p>${data.content}</p>
        <small class="timestamp">${data.timestamp} ‚Ä¢ ${data.sender_name}</small>
      </div>`;
    messagesDiv.appendChild(bubble);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  });

  document.getElementById("aiForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const input = document.getElementById("aiInput").value.trim();
    if (!input) return;

    const resBox = document.getElementById("aiResponse");
    resBox.style.display = "block";
    resBox.innerHTML = "<em>‚è≥ Thinking...</em>";

    try {
      const response = await fetch("{{ url_for('borrower.ask_ai_post') }}", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ question: input })
      });
      const data = await response.json();
      resBox.innerHTML = data.reply || "‚ö†Ô∏è No AI response.";
    } catch (err) {
      resBox.innerHTML = "‚ö†Ô∏è Unable to reach AI service.";
    }
  });
</script>

{% endblock %}
