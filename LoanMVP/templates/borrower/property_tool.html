{% extends "layouts/borrower_base.html" %}
{% block title %}Property Tool ‚Ä¢ Ravlo{% endblock %}

{% block content %}
<div class="b-card" style="margin-bottom:1rem;">
  <h2 style="margin:0 0 .35rem 0;">üîé Ravlo Property Tool</h2>
  <p class="muted" style="margin:0;">Search by ZIP and get deal metrics for flips or rentals.</p>
</div>

<div class="b-grid-2" style="grid-template-columns: 1fr 1.6fr; gap:1rem;">
  <div class="b-card">
    <h3 style="margin-top:0;">Search</h3>

    <label class="muted" style="display:block;margin:.5rem 0 .25rem;">ZIP Code</label>
    <input id="zip" class="dw-input" placeholder="e.g., 10924" />

    <label class="muted" style="display:block;margin:.75rem 0 .25rem;">Strategy</label>
    <select id="strategy" class="dw-input">
      <option value="flip">Fixer-Upper (Flip)</option>
      <option value="rental">Rental (Cashflow)</option>
      <option value="all">All</option>
    </select>

    <div class="dw-row" style="margin-top:.75rem;">
      <div>
        <label class="muted" style="display:block;margin:0 0 .25rem;">Min Price</label>
        <input id="price_min" class="dw-input" type="number" placeholder="0" />
      </div>
      <div>
        <label class="muted" style="display:block;margin:0 0 .25rem;">Max Price</label>
        <input id="price_max" class="dw-input" type="number" placeholder="500000" />
      </div>
    </div>

    <div class="dw-row" style="margin-top:.5rem;">
      <div>
        <label class="muted" style="display:block;margin:0 0 .25rem;">Beds ‚â•</label>
        <input id="beds_min" class="dw-input" type="number" placeholder="2" />
      </div>
      <div>
        <label class="muted" style="display:block;margin:0 0 .25rem;">Baths ‚â•</label>
        <input id="baths_min" class="dw-input" type="number" placeholder="1" />
      </div>
    </div>

    <div class="dw-row" style="margin-top:.5rem;">
      <div>
        <label class="muted" style="display:block;margin:0 0 .25rem;">Min ROI (flip)</label>
        <input id="min_roi" class="dw-input" type="number" step="0.01" placeholder="0.20" />
      </div>
      <div>
        <label class="muted" style="display:block;margin:0 0 .25rem;">Min Cashflow (rental)</label>
        <input id="min_cashflow" class="dw-input" type="number" placeholder="300" />
      </div>
    </div>

    <button class="lux-btn lux-btn-primary" style="margin-top:1rem;width:100%;" onclick="runSearch()">
      <span class="lux-ic">üîç</span> Run Search
    </button>

    <div id="searchStatus" class="muted" style="margin-top:.75rem;"></div>
  </div>

  <div>
    <div id="results" class="bling-grid-3" style="grid-template-columns:repeat(2,minmax(0,1fr));"></div>
  </div>
</div>

<script>
function money(x){
  if (x === null || x === undefined || x === "") return "‚Äî";
  const n = Number(x);
  if (Number.isNaN(n)) return "‚Äî";
  return "$" + n.toLocaleString(undefined, {maximumFractionDigits:0});
}

function numOrNull(v){
  if (v === null || v === undefined) return null;
  const s = String(v).trim();
  if (!s) return null;
  const n = Number(s);
  return Number.isNaN(n) ? null : n;
}

async function saveAndAnalyze(item){
  // button UI
  const btn = document.getElementById(item._btnId);
  if (btn){
    btn.disabled = true;
    btn.innerText = "Saving‚Ä¶";
  }

  try{
    const resp = await fetch("{{ url_for('borrower.api_property_tool_save') }}", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({
        address: item.address || "",
        city: item.city || "",
        state: item.state || "",
        zip: item.zip || "",
        price: item.price ?? null,
        sqft: item.sqft ?? null,
        photo: item.photo || null,
        property_id: item.property_id || null
      })
    });

    const data = await resp.json();
    if (data.status !== "ok"){
      alert(data.message || "Could not save property.");
      if (btn){
        btn.disabled = false;
        btn.innerText = "üìà Send to Deal Workspace";
      }
      return;
    }

    // redirect to Deal Workspace using prop_id
    window.location.href = data.deal_url;

  } catch (e){
    console.error(e);
    alert("Network error while saving. Try again.");
    if (btn){
      btn.disabled = false;
      btn.innerText = "üìà Send to Deal Workspace";
    }
  }
}

async function saveOnly(item){
  const btn = document.getElementById(item._saveBtnId);
  if (btn){
    btn.disabled = true;
    btn.innerText = "Saving‚Ä¶";
  }

  try{
    const resp = await fetch("{{ url_for('borrower.api_property_tool_save') }}", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({
        address: item.address || "",
        city: item.city || "",
        state: item.state || "",
        zip: item.zip || "",
        price: item.price ?? null,
        sqft: item.sqft ?? null,
        photo: item.photo || null,
        property_id: item.property_id || null
      })
    });

    const data = await resp.json();
    if (data.status !== "ok"){
      alert(data.message || "Could not save property.");
      if (btn){
        btn.disabled = false;
        btn.innerText = "üíæ Save";
      }
      return;
    }

    if (btn){
      btn.innerText = "‚úÖ Saved";
      setTimeout(() => {
        btn.disabled = false;
        btn.innerText = "üíæ Save";
      }, 1200);
    }

  } catch (e){
    console.error(e);
    alert("Network error while saving. Try again.");
    if (btn){
      btn.disabled = false;
      btn.innerText = "üíæ Save";
    }
  }
}

async function runSearch(){
  const zip = document.getElementById("zip").value.trim();
  const strategy = document.getElementById("strategy").value;

  const payload = {
    zip,
    strategy,
    price_min: numOrNull(document.getElementById("price_min").value),
    price_max: numOrNull(document.getElementById("price_max").value),
    beds_min:  numOrNull(document.getElementById("beds_min").value),
    baths_min: numOrNull(document.getElementById("baths_min").value),
    min_roi:   numOrNull(document.getElementById("min_roi").value),
    min_cashflow: numOrNull(document.getElementById("min_cashflow").value),
    limit: 20
  };

  const status = document.getElementById("searchStatus");
  const results = document.getElementById("results");
  status.innerText = "Searching‚Ä¶";
  results.innerHTML = "";

  const resp = await fetch("{{ url_for('borrower.api_property_tool_search') }}", {
    method:"POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(payload)
  });

  const data = await resp.json();
  if (data.status !== "ok"){
    status.innerText = data.message || "Search failed.";
    return;
  }

  status.innerText = `Found ${data.results.length} opportunities in ${data.zip}.`;

  // Build cards
  results.innerHTML = data.results.map((r, idx) => {
    const m = r.metrics || {};
    const safeId = `dw_${idx}_${Date.now()}`;
    const saveId = `sv_${idx}_${Date.now()}`;

    // Some providers give propertyId/id. Keep it if we have it.
    const propertyId = r.property_id || r.propertyId || r.id || null;

    // Create a JS object encoded inside attribute later via onclick wrapper
    // We'll pass only what we need.
    const payloadObj = {
      address: r.address || "",
      city: r.city || "",
      state: r.state || "",
      zip: r.zip || "",
      price: r.price ?? null,
      sqft: r.sqft ?? null,
      photo: r.photo || null,
      property_id: propertyId,
      _btnId: safeId,
      _saveBtnId: saveId
    };

    const encoded = encodeURIComponent(JSON.stringify(payloadObj));

    return `
      <div class="bling-card">
        <div style="display:flex;gap:.8rem;align-items:flex-start;">
          <div style="width:64px;height:64px;border-radius:16px;overflow:hidden;border:1px solid var(--lux-border);background:rgba(255,255,255,.04);flex:0 0 auto;">
            ${r.photo ? `<img src="${r.photo}" style="width:100%;height:100%;object-fit:cover;">` : ""}
          </div>
          <div style="min-width:0;">
            <div style="font-weight:900;color:var(--lux-text);font-size:.95rem;line-height:1.2;">
              ${r.address || "‚Äî"}
            </div>
            <div class="muted" style="font-size:.78rem;margin-top:.2rem;">
              ${r.city || ""} ${r.state || ""} ${r.zip || ""}
            </div>
          </div>
        </div>

        <div style="margin-top:.75rem;display:grid;grid-template-columns:1fr 1fr;gap:.5rem;font-size:.78rem;">
          <div><span class="muted">Price</span><br><strong>${money(r.price)}</strong></div>
          <div><span class="muted">Sqft</span><br><strong>${r.sqft || "‚Äî"}</strong></div>
          <div><span class="muted">Flip Profit</span><br><strong>${money(m.profit)}</strong></div>
          <div><span class="muted">Flip ROI</span><br><strong>${m.roi !== undefined && m.roi !== null ? Math.round(m.roi*100) + "%" : "‚Äî"}</strong></div>
          <div><span class="muted">Rent Est</span><br><strong>${money(m.rent_est)}</strong></div>
          <div><span class="muted">Cashflow</span><br><strong>${money(m.net_cashflow_mo)}</strong></div>
        </div>

        <div style="margin-top:.75rem;display:flex;gap:.5rem;flex-wrap:wrap;">
          <button
            id="${safeId}"
            type="button"
            class="lux-btn lux-btn-ghost"
            style="padding:.55rem .8rem;"
            onclick='saveAndAnalyze(JSON.parse(decodeURIComponent("${encoded}")))'>
            <span class="lux-ic">üìà</span> Send to Deal Workspace
          </button>

          <button
            id="${saveId}"
            type="button"
            class="lux-btn lux-btn-ghost"
            style="padding:.55rem .8rem; opacity:.9;"
            onclick='saveOnly(JSON.parse(decodeURIComponent("${encoded}")))'>
            <span class="lux-ic">üíæ</span> Save
          </button>
        </div>
      </div>
    `;
  }).join("");
}
</script>

<style>
/* Readability fix: avoid ‚Äúwashed out‚Äù text */
.muted{ color: rgba(230,235,240,.70) !important; }

.dw-input{
  width:100%;
  padding:.75rem .85rem;
  border-radius:14px;
  background: rgba(255,255,255,.04);
  border: 1px solid rgba(255,255,255,.10);
  color: rgba(230,235,240,.92);
  outline: none;
}
.dw-input::placeholder{ color: rgba(230,235,240,.45); }
.dw-input:focus{
  border-color: rgba(217,221,228,.35);
  box-shadow: 0 0 0 4px rgba(217,221,228,.08);
}
</style>
{% endblock %}
