{# templates/borrower/property_search.html #}
{% extends "layouts/borrower_base.html" %}
{% block title %}Property Search{% endblock %}
{% block content %}

<div class="b-main-inner">

  <div class="page-header" style="margin-bottom:1rem;">
    <h2 style="margin:0;">üè† Property Search</h2>
    <p class="muted" style="margin:.35rem 0 0 0;">
      Search any address and instantly see property details. Analyze will auto-save first.
    </p>
  </div>

  <!-- Search Bar -->
  <form method="GET" class="b-card" style="margin-top:1rem;">
    <input
      type="text"
      name="query"
      placeholder="Enter an address..."
      value="{{ query or '' }}"
      style="width:100%; padding:0.75rem; font-size:1rem;"
      autocomplete="street-address"
    >
    <button type="submit" class="btn" style="margin-top:0.75rem;">Search</button>
  </form>

  <!-- Error -->
  {% if error %}
    <div class="b-card" style="margin-top:1rem; border-left:4px solid #ff4d4d;">
      <strong style="color:#b30000;">Lookup Error</strong>
      <p class="muted" style="margin-top:.5rem;">
        {{ error }}
        {% if debug %}
          <br>Provider: {{ debug.provider or "‚Äî" }} | Stage: {{ debug.stage or "‚Äî" }}
        {% endif %}
      </p>
    </div>
  {% endif %}

  {% if property %}
  <div class="b-card" style="margin-top:1.5rem;">

    {# ---- safe locals ---- #}
    {% set valuation = valuation if valuation is defined else (property.valuation if property and property.valuation is defined else {}) %}
    {% set rent_estimate = rent_estimate if rent_estimate is defined else (property.rent_estimate if property and property.rent_estimate is defined else {}) %}
    {% set comps = comps if comps is defined else (property.comps if property and property.comps is defined else {}) %}

    {# Photos #}
    {% if property.photos %}
      {% if property.photos is string %}
        <img
          src="{{ property.photos }}"
          alt="Property photo"
          style="width:100%; max-height:320px; object-fit:cover; border-radius:12px; margin-bottom:1rem;"
        >
      {% else %}
        <div style="display:flex; gap:1rem; overflow-x:auto; margin-bottom:1rem; padding-bottom:.25rem;">
          {% for photo in property.photos[:8] %}
            <img
              src="{{ photo }}"
              alt="Property photo"
              style="height:200px; border-radius:10px; object-fit:cover;"
            >
          {% endfor %}
        </div>
      {% endif %}
    {% endif %}

    {# Address #}
    <h3 style="margin-bottom:0.25rem;">
      {{ property.address }}
      {% if property.city %}, {{ property.city }}{% endif %}
      {% if property.state %}, {{ property.state }}{% endif %}
      {% if property.zip %} {{ property.zip }}{% endif %}
    </h3>

    {# Price / Value #}
    <p style="font-size:1.35rem; font-weight:700; margin-bottom:0.5rem;">
      {% if property.price %}
        ${{ "{:,.0f}".format(property.price) }}
        <span class="muted" style="font-size:.85rem;">(Listed Price)</span>
      {% elif valuation and (valuation.estimate is defined and valuation.estimate) %}
        ${{ "{:,.0f}".format(valuation.estimate) }}
        <span class="muted" style="font-size:.85rem;">(Estimated Value)</span>
      {% else %}
        <span class="muted">Off-market property ‚Ä¢ Showing investor estimates when available</span>
      {% endif %}
    </p>

    {# Specs #}
    <p class="muted">
      {{ property.beds or "‚Äî" }} üõè &nbsp;|&nbsp;
      {{ property.baths or "‚Äî" }} üõÅ &nbsp;|&nbsp;
      {{ property.sqft or "‚Äî" }} sq ft &nbsp;|&nbsp;
      Built {{ property.year_built or "‚Äî" }}
    </p>

    {# Deal Snapshot #}
    <div class="b-card" style="margin-top:1rem;">
      <strong>Deal Snapshot</strong>

      <div style="display:flex; flex-wrap:wrap; gap:1rem; margin-top:0.75rem;">

        <div style="min-width:180px;">
          <div class="muted" style="font-size:0.9rem;">Estimated Value (AVM)</div>
          <div style="font-weight:700;">
            {% if valuation and valuation.estimate is defined and valuation.estimate %}
              ${{ "{:,.0f}".format(valuation.estimate|float) }}
            {% else %}
              ‚Äî
            {% endif %}
          </div>
        </div>

        <div style="min-width:180px;">
          <div class="muted" style="font-size:0.9rem;">Estimated Rent (Monthly)</div>
          <div style="font-weight:700;">
            {% if rent_estimate and (rent_estimate.rent is defined and rent_estimate.rent) %}
              ${{ "{:,.0f}".format(rent_estimate.rent|float) }}/mo
            {% else %}
              ‚Äî
            {% endif %}
          </div>
        </div>

        <div style="min-width:140px;">
          <div class="muted" style="font-size:0.9rem;">Sales Comps</div>
          <div style="font-weight:700;">
            {% if comps and comps.sales is defined and comps.sales %}
              {{ comps.sales|length }}
            {% else %}
              ‚Äî
            {% endif %}
          </div>
        </div>

        <div style="min-width:140px;">
          <div class="muted" style="font-size:0.9rem;">Rental Comps</div>
          <div style="font-weight:700;">
            {% if comps and comps.rentals is defined and comps.rentals %}
              {{ comps.rentals|length }}
            {% else %}
              ‚Äî
            {% endif %}
          </div>
        </div>

      </div>
    </div>

    {# AI Summary #}
    {% if ai_summary %}
      <div class="b-card" style="margin-top:1rem;">
        <strong>AI Market Insight</strong>
        <p style="margin-top:0.5rem;">{{ ai_summary }}</p>
      </div>
    {% endif %}

    {# Actions #}
    <div style="display:flex; gap:.75rem; flex-wrap:wrap; margin-top:1.25rem; align-items:center;">

      {# ---- Save only (AJAX) ---- #}
      <form method="POST" action="{{ url_for('borrower.save_property') }}" id="savePropertyForm" style="margin:0;">
        {{ csrf_token() if csrf_token is defined }}

        <input type="hidden" name="property_id" value="{{ property.property_id or property.id or '' }}">
        <input type="hidden" name="address" value="{{ property.address }}">
        <input type="hidden" name="price" value="{{ property.price or (valuation.estimate if valuation and valuation.estimate is defined else 0) or 0 }}">
        <input type="hidden" name="zipcode" value="{{ property.zip or '' }}">
        <input type="hidden" name="sqft" value="{{ property.sqft or '' }}">

        <button type="submit" class="btn" id="btnSaveOnly">Save Property</button>
      </form>

      {# ---- Analyze (AUTO-SAVE + REDIRECT) ---- #}
      <form method="POST" action="{{ url_for('borrower.save_property_and_analyze') }}" id="analyzeForm" style="margin:0;">
        {{ csrf_token() if csrf_token is defined }}

        <input type="hidden" name="property_id" value="{{ property.property_id or property.id or '' }}">
        <input type="hidden" name="address" value="{{ property.address }}">
        <input type="hidden" name="price" value="{{ property.price or (valuation.estimate if valuation and valuation.estimate is defined else 0) or 0 }}">
        <input type="hidden" name="zipcode" value="{{ property.zip or '' }}">
        <input type="hidden" name="sqft" value="{{ property.sqft or '' }}">

        <button type="submit" class="btn" id="btnAnalyze">Analyze Deal ‚ûú</button>
      </form>

      {# ---- If already saved, direct open ---- #}
      {% if saved_id %}
        <a href="{{ url_for('borrower.deal_workspace', prop_id=saved_id, mode='flip') }}" class="btn">
          Open Deal Workspace ‚ûú
        </a>
      {% endif %}

      <span id="saveStatus" class="muted" style="font-size:.9rem;"></span>
    </div>

  </div>
  {% endif %}

</div>

<script>
(function () {
  const saveForm = document.getElementById("savePropertyForm");
  const analyzeForm = document.getElementById("analyzeForm");
  const statusEl = document.getElementById("saveStatus");
  const btnSave = document.getElementById("btnSaveOnly");
  const btnAnalyze = document.getElementById("btnAnalyze");

  async function postForm(form) {
    const resp = await fetch(form.action, { method: "POST", body: new FormData(form) });
    // If server redirects (analyze route), fetch will follow and return HTML.
    const ct = (resp.headers.get("content-type") || "").toLowerCase();
    if (ct.includes("application/json")) {
      return { type: "json", resp, data: await resp.json() };
    }
    return { type: "html", resp, text: await resp.text() };
  }

  if (saveForm) {
    saveForm.addEventListener("submit", async function (e) {
      e.preventDefault();
      if (statusEl) statusEl.textContent = "Saving...";
      if (btnSave) btnSave.disabled = true;

      try {
        const result = await postForm(saveForm);
        if (result.type === "json") {
          if (statusEl) statusEl.textContent = result.data.message || "Saved!";
          alert(result.data.message || "Saved!");
        } else {
          // Fallback: if server returned HTML, just reload
          if (statusEl) statusEl.textContent = "Saved.";
          window.location.reload();
        }
      } catch (err) {
        console.error(err);
        if (statusEl) statusEl.textContent = "Save failed.";
        alert("Save failed. Check logs.");
      } finally {
        if (btnSave) btnSave.disabled = false;
      }
    });
  }

  // Analyze should POST normally so Flask can redirect to Deal Workspace
  if (analyzeForm) {
    analyzeForm.addEventListener("submit", function () {
      if (statusEl) statusEl.textContent = "Saving & opening Deal Workspace...";
      if (btnAnalyze) btnAnalyze.disabled = true;
    });
  }
})();
</script>

{% endblock %}
