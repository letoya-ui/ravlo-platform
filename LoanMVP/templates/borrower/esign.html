{% extends "layouts/borrower_base.html" %}
{% block title %}eSignature Center • Borrower Portal{% endblock %}
{% block content %}

<div class="borrower-shell">

  <!-- SIDEBAR -->
  <aside class="b-sidebar">
    <div class="b-sidebar-logo">CM</div>

    <div class="b-sidebar-group">

      <a href="{{ url_for('borrower.dashboard') }}" class="b-sidebar-item">
        <svg viewBox="0 0 24 24" fill="none">
          <rect x="3" y="3" width="8" height="8" rx="2"></rect>
          <rect x="13" y="3" width="8" height="5" rx="2"></rect>
          <rect x="13" y="10" width="8" height="11" rx="2"></rect>
          <rect x="3" y="13" width="8" height="8" rx="2"></rect>
        </svg>
        <div class="b-tooltip">Dashboard</div>
      </a>

      <a href="{{ url_for('borrower.property_search') }}" class="b-sidebar-item">
        <svg viewBox="0 0 24 24" fill="none">
          <path d="M12 3L4 9v11h16V9l-8-6Z"></path>
          <circle cx="12" cy="13" r="2.5"></circle>
        </svg>
        <div class="b-tooltip">Property Finder</div>
      </a>

      <a href="{{ url_for('borrower.resource_center') }}" class="b-sidebar-item">
        <svg viewBox="0 0 24 24" fill="none">
          <circle cx="8" cy="8" r="3"></circle>
          <circle cx="16" cy="8" r="3"></circle>
          <path d="M4 19c.6-2.4 2.3-4 4-4s3.4 1.6 4 4"></path>
          <path d="M12 19c.6-2.4 2.3-4 4-4s3.4 1.6 4 4"></path>
        </svg>
        <div class="b-tooltip">Partner Network</div>
      </a>

      <a href="{{ url_for('borrower.deal_workspace') }}" class="b-sidebar-item">
        <svg viewBox="0 0 24 24" fill="none">
          <rect x="4" y="4" width="16" height="16" rx="2"></rect>
          <path d="M8 9h8M8 13h5M8 17h3"></path>
        </svg>
        <div class="b-tooltip">Project Planner</div>
      </a>

      <a href="{{ url_for('borrower.saved_properties') }}" class="b-sidebar-item">
        <svg viewBox="0 0 24 24" fill="none">
          <path d="M12 20s-4.5-2.7-6.7-5.4C3.4 13 3 11.9 3 10.8 3 8.7 4.7 7 6.8 7c1.2 0 2.3.6 3 1.5.7-.9 1.8-1.5 3-1.5C15.3 7 17 8.7 17 10.8c0 1.1-.4 2.2-2.3 3.8C16.5 17.3 12 20 12 20Z"></path>
        </svg>
        <div class="b-tooltip">Saved Properties</div>
      </a>

      <a href="{{ url_for('borrower.resource_center') }}" class="b-sidebar-item">
        <svg viewBox="0 0 24 24" fill="none">
          <path d="M5 4h10a3 3 0 0 1 3 3v13l-4-2-4 2-4-2-4 2V7a3 3 0 0 1 3-3Z"></path>
        </svg>
        <div class="b-tooltip">Resource Center</div>
      </a>

    </div>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="b-main">

    <!-- TOP TABS -->
    <div class="b-top-tabs">
      <a href="{{ url_for('borrower.dashboard') }}" class="b-top-tab">Dashboard</a>
      <a href="{{ url_for('borrower.documents') }}" class="b-top-tab">Documents</a>
      <div class="b-top-tab active">eSignature</div>
    </div>

    <!-- PAGE CONTENT -->
    <h1>✒️ eSignature Center</h1>
    <p class="muted">Sign required loan disclosures and authorizations securely.</p>

    {% for d in docs %}
    <div class="b-card" style="margin-top:1rem;">
        <h3>{{ d.name }}</h3>
        <p class="muted">Status: {{ d.status }}</p>

        {% if d.status != "Signed" %}
        <button onclick="openSign('{{ d.id }}')" class="action-btn">
            Sign Document
        </button>
        {% else %}
        <p class="muted">✔ Signed</p>
        {% endif %}
    </div>
    {% endfor %}

  </main>
</div>

<!-- Signature Modal -->
<div id="signModal" style="display:none; position:fixed; left:0; top:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:9999;">
    <div style="width:600px; margin:5rem auto; background:#15161a; padding:2rem; border-radius:16px;">

        <h2>Draw Your Signature</h2>
        <canvas id="signaturePad" class="sign-pad"></canvas>

        <form id="signForm" method="POST">
            <input type="hidden" name="signature_data" id="signatureData">
            <button class="action-btn" type="submit">Submit Signature</button>
            <button class="action-btn" type="button" onclick="closeSign()">Cancel</button>
        </form>
    </div>
</div>

<style>
.sign-pad {
    width:100%;
    height:200px;
    background:#000;
    border:1px solid var(--line);
    border-radius:10px;
    cursor:crosshair;
}
</style>

<script>
let currentDoc = null;
const canvas = document.getElementById('signaturePad');
const ctx = canvas.getContext('2d');
let drawing = false;

canvas.addEventListener('mousedown', () => drawing = true);
canvas.addEventListener('mouseup', () => drawing = false);
canvas.addEventListener('mousemove', draw);

function draw(e) {
    if (!drawing) return;
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    ctx.strokeStyle = '#fff';
    ctx.lineTo(e.offsetX, e.offsetY);
    ctx.stroke();
}

function openSign(docId) {
    currentDoc = docId;
    document.getElementById('signModal').style.display = 'block';
    ctx.clearRect(0,0,canvas.width,canvas.height);
    document.getElementById('signForm').action = "/portal/esign/sign/" + docId;
}

function closeSign() {
    document.getElementById('signModal').style.display = 'none';
}

document.getElementById('signForm').addEventListener('submit', function(e) {
    const data = canvas.toDataURL();
    document.getElementById('signatureData').value = data;
});
</script>

{% endblock %}
