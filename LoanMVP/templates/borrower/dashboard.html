{% extends "layouts/ravlo_base.html" %}
{% block title %}Ravlo • Command Center{% endblock %}

{% block page_title %}RAVLO{% endblock %}
{% block page_subline %}Your capital, deals, and funding — in one place.{% endblock %}

{% block topbar_actions %}
  <button class="ravlo-btn ghost sm" type="button"
          onclick="location.href='{{ url_for('deals.index') if 'deals.index' in current_app.view_functions else '#' }}'">
    View Deals
  </button>
  <button class="ravlo-btn primary sm" type="button"
          onclick="location.href='{{ url_for('deals.new') if 'deals.new' in current_app.view_functions else '#' }}'">
    New Deal
  </button>
{% endblock %}

{% block content %}

  <!-- =========================
       KPI STRIP
  ========================== -->
  <div class="ravlo-grid cols-4">
    <div class="ravlo-kpi">
      <div class="value">{{ kpi_funding_needed or "$0" }}</div>
      <div class="label">Funding Needed</div>
    </div>
    <div class="ravlo-kpi">
      <div class="value">{{ kpi_active_deals or "0" }}</div>
      <div class="label">Active Deals</div>
    </div>
    <div class="ravlo-kpi">
      <div class="value">{{ kpi_saved_properties or "0" }}</div>
      <div class="label">Saved Properties</div>
    </div>
    <div class="ravlo-kpi">
      <div class="value">{{ kpi_docs_outstanding or "0" }}</div>
      <div class="label">Docs Outstanding</div>
    </div>
  </div>

  <!-- =========================
       MAIN GRID
  ========================== -->
  <div class="ravlo-grid cols-2 mt-16">

    <!-- ACTIVE DEALS -->
    <div class="ravlo-card pad">
      <div class="row between">
        <div class="ravlo-card-title">Active Deals</div>
        <button class="ravlo-btn ghost sm" type="button"
                onclick="location.href='{{ url_for('deals.index') if 'deals.index' in current_app.view_functions else '#' }}'">
          View All
        </button>
      </div>

      <div class="mt-12">
        <table class="ravlo-table">
          <thead>
            <tr>
              <th>Deal</th>
              <th>Status</th>
              <th>Stage</th>
              <th style="text-align:right;">Action</th>
            </tr>
          </thead>
          <tbody>
            {% if active_deals %}
              {% for d in active_deals %}
              <tr>
                <td>
                  <div style="font-weight:700;color:var(--text);">{{ d.name or d.address or "Deal" }}</div>
                  <div style="font-size:12px;color:var(--muted);margin-top:2px;">
                    {{ d.city or "" }} {{ d.state or "" }} {{ d.zipcode or "" }}
                  </div>
                </td>
                <td>
                  {% set st = (d.status or "OPEN")|upper %}
                  <span class="ravlo-badge {% if st in ['OPEN','ACTIVE'] %}ok{% elif st in ['PENDING','REVIEW'] %}watch{% else %}risk{% endif %}">
                    {{ st }}
                  </span>
                </td>
                <td style="color:var(--muted);">
                  {{ d.stage or "Intake" }}
                </td>
                <td style="text-align:right;">
                  <button class="ravlo-btn primary sm" type="button"
                    onclick="location.href='{{ url_for('deals.view', deal_id=d.id) if 'deals.view' in current_app.view_functions else '#' }}'">
                    Open
                  </button>
                </td>
              </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="4" style="color:var(--muted);">
                  No active deals yet. Create your first deal to get started.
                </td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- RAVLO INSIGHT + QUICK ACTIONS -->
    <div class="ravlo-card pad">

      <div class="ravlo-insight">
        <p class="k">Ravlo Insight</p>
        <p class="v">
          {{ ravlo_insight or "I’m here to help you understand each deal clearly. If something looks tight, I’ll flag it — and if you want, we can explore a few scenarios." }}
        </p>
        <div class="row mt-12">
          <button class="ravlo-btn primary sm" type="button"
            onclick="location.href='{{ url_for('deals.index') if 'deals.index' in current_app.view_functions else '#' }}'">
            Explore Deals
          </button>
          <button class="ravlo-btn ghost sm" type="button"
            onclick="location.href='{{ url_for('strategy.profile') if 'strategy.profile' in current_app.view_functions else '#' }}'">
            Strategy Profile
          </button>
        </div>
      </div>

      <div class="mt-16 ravlo-grid cols-2">
        <div class="ravlo-kpi" style="min-height:92px;">
          <div class="value">{{ kpi_preapproval or "—" }}</div>
          <div class="label">Pre-Approval</div>
        </div>
        <div class="ravlo-kpi" style="min-height:92px;">
          <div class="value">{{ kpi_rate_watch or "—" }}</div>
          <div class="label">Rate Watch</div>
        </div>
      </div>

      <div class="mt-16">
        <div class="ravlo-card-title">Quick Actions</div>
        <div class="ravlo-grid cols-2 mt-12">
          <button class="ravlo-btn ghost" type="button"
            onclick="location.href='{{ url_for('intelligence.index') if 'intelligence.index' in current_app.view_functions else '#' }}'">
            Property Intelligence
          </button>
          <button class="ravlo-btn ghost" type="button"
            onclick="location.href='{{ url_for('documents.index') if 'documents.index' in current_app.view_functions else '#' }}'">
            Upload Documents
          </button>
          <button class="ravlo-btn ghost" type="button"
            onclick="location.href='{{ url_for('capital.index') if 'capital.index' in current_app.view_functions else '#' }}'">
            Funding Options
          </button>
          <button class="ravlo-btn ghost" type="button"
            onclick="location.href='{{ url_for('app.support') if 'app.support' in current_app.view_functions else '#' }}'">
            Contact Team
          </button>
        </div>
      </div>

    </div>
  </div>

  <!-- =========================
       SAVED PROPERTIES + TEAM
  ========================== -->
  <div class="ravlo-grid cols-2 mt-16">

    <!-- SAVED PROPERTIES -->
    <div class="ravlo-card pad">
      <div class="row between">
        <div class="ravlo-card-title">Saved Properties</div>
        <button class="ravlo-btn ghost sm" type="button"
          onclick="location.href='{{ url_for('intelligence.saved') if 'intelligence.saved' in current_app.view_functions else '#' }}'">
          View Saved
        </button>
      </div>

      <div class="mt-12">
        <table class="ravlo-table">
          <thead>
            <tr>
              <th>Address</th>
              <th>Type</th>
              <th style="text-align:right;">Action</th>
            </tr>
          </thead>
          <tbody>
            {% if saved_properties %}
              {% for p in saved_properties %}
              <tr>
                <td>
                  <div style="font-weight:700;color:var(--text);">{{ p.address }}</div>
                  <div style="font-size:12px;color:var(--muted);margin-top:2px;">
                    {{ p.city or "" }} {{ p.state or "" }} {{ p.zipcode or "" }}
                  </div>
                </td>
                <td style="color:var(--muted);">{{ p.asset_type or "Residential" }}</td>
                <td style="text-align:right;">
                  <button class="ravlo-btn primary sm" type="button"
                    onclick="location.href='{{ url_for('intelligence.view_property', property_id=p.id) if 'intelligence.view_property' in current_app.view_functions else '#' }}'">
                    Open
                  </button>
                </td>
              </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="3" style="color:var(--muted);">
                  No saved properties yet. Use Property Intelligence to save targets.
                </td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- YOUR TEAM -->
    <div class="ravlo-card pad">
      <div class="ravlo-card-title">Your Team</div>

      <div class="mt-12 ravlo-grid cols-2">
        <!-- Loan Officer -->
        <div class="ravlo-card pad" style="padding:14px;">
          <div style="font-weight:800;">Loan Officer</div>
          <div style="margin-top:6px;color:var(--muted);font-size:13px;">
            {{ loan_officer.name if loan_officer else "Not assigned yet" }}
          </div>
          <div style="margin-top:8px;display:flex;gap:10px;flex-wrap:wrap;">
            <button class="ravlo-btn ghost sm" type="button"
              onclick="location.href='{{ url_for('app.contact_officer') if 'app.contact_officer' in current_app.view_functions else '#' }}'">
              Message
            </button>
            {% if loan_officer and loan_officer.email %}
            <a class="ravlo-btn ghost sm" style="text-decoration:none;display:inline-flex;align-items:center;"
               href="mailto:{{ loan_officer.email }}">Email</a>
            {% endif %}
          </div>
        </div>

        <!-- Processor -->
        <div class="ravlo-card pad" style="padding:14px;">
          <div style="font-weight:800;">Processor</div>
          <div style="margin-top:6px;color:var(--muted);font-size:13px;">
            {{ processor.name if processor else "Not assigned yet" }}
          </div>
          <div style="margin-top:8px;display:flex;gap:10px;flex-wrap:wrap;">
            <button class="ravlo-btn ghost sm" type="button"
              onclick="location.href='{{ url_for('app.contact_processor') if 'app.contact_processor' in current_app.view_functions else '#' }}'">
              Message
            </button>
            {% if processor and processor.email %}
            <a class="ravlo-btn ghost sm" style="text-decoration:none;display:inline-flex;align-items:center;"
               href="mailto:{{ processor.email }}">Email</a>
            {% endif %}
          </div>
        </div>

        <!-- Partners -->
        <div class="ravlo-card pad" style="padding:14px; grid-column: 1 / -1;">
          <div style="font-weight:800;">Partners</div>
          <div style="margin-top:6px;color:var(--muted);font-size:13px;">
            Find agents, contractors, and capital partners aligned with your strategy.
          </div>
          <div class="mt-12">
            <button class="ravlo-btn primary sm" type="button"
              onclick="location.href='{{ url_for('app.partners') if 'app.partners' in current_app.view_functions else '#' }}'">
              Find Partners
            </button>
            <button class="ravlo-btn ghost sm" type="button"
              onclick="location.href='{{ url_for('app.support') if 'app.support' in current_app.view_functions else '#' }}'">
              Contact Support
            </button>
          </div>
        </div>
      </div>

    </div>
  </div>

{% endblock %}
