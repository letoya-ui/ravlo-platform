{% extends "layouts/base.html" %}
{% block title %}Processor Panel ‚Ä¢ Caughman Mason{% endblock %}

{% block content %}

<link rel="stylesheet" href="https://unpkg.com/lucide-static@latest/font/lucide.css">

<style>
:root {
    --bg:#0f0f11;
    --panel:#15161a;
    --line:#2b2f36;
    --text:#e6e6e6;
    --muted:#a5a7ad;
    --accent:#7ab8ff;
    --hover:#1f2328;
    --glow:0 0 14px rgba(122,184,255,0.35);
}

body { background: var(--bg); color: var(--text); }

.section {
    background: var(--panel);
    border: 1px solid var(--line);
    border-radius: 14px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 0 18px rgba(0,0,0,0.4);
}

h2, h3 { text-shadow: var(--glow); }

.doc-row {
    background: #1a1c20;
    border: 1px solid var(--line);
    padding: 1rem;
    border-radius: 10px;
    margin-bottom: 1rem;
}

.btn {
    padding: .5rem 1rem;
    background: transparent;
    border: 1px solid var(--accent);
    color: var(--accent);
    border-radius: 8px;
    cursor: pointer;
}
.btn:hover { background: var(--accent); color: #000; }

textarea, input {
    width: 100%;
    padding: .6rem;
    background: #1a1c20;
    border: 1px solid var(--line);
    color: var(--text);
    border-radius: 8px;
}
</style>

<main class="dashboard-main">

<!-- =======================================================
     PROCESSOR HEADER
======================================================= -->
<section class="section">
    <h2>‚öôÔ∏è Processor Document Verification</h2>

    <p class="muted">
        Borrower: <strong>{{ borrower.full_name }}</strong><br>
        Loan #: <strong>{{ loan.id }}</strong><br>
        Status: <strong>{{ loan.status }}</strong>
    </p>
</section>


<!-- =======================================================
     CREDIT SUMMARY
======================================================= -->
<section class="section">
    <h3>üìå Credit Summary</h3>

    {% if borrower.credit_reports %}
        {% set credit = borrower.credit_reports[-1] %}

        <p><strong>Credit Score:</strong> {{ credit.credit_score }}</p>
        <p><strong>Date:</strong> {{ credit.created_at.strftime("%b %d, %Y %I:%M %p") }}</p>

        <a class="btn" onclick="alert(JSON.stringify({{ credit.credit_data|tojson }}, null, 2))">
            View Raw Credit JSON
        </a>
    {% else %}
        <p class="muted">No credit report on file.</p>
    {% endif %}

    <form method="POST" action="/master/pull_credit/{{ borrower.id }}" style="margin-top:1rem;">
        <button class="btn">üîÑ Pull Soft Credit</button>
    </form>
</section>


<!-- =======================================================
     LOAN RATIO ANALYSIS (DTI + LTV)
======================================================= -->
<section class="section">
    <h3>üìä Loan Ratios</h3>

    <p><strong>LTV:</strong>
        {% if loan.ltv_ratio %} {{ loan.ltv_ratio }}% {% else %} N/A {% endif %}
    </p>

    <p><strong>Front-End DTI:</strong>
        {% if loan.front_end_dti %} {{ loan.front_end_dti }}% {% else %} N/A {% endif %}
    </p>

    <p><strong>Back-End DTI:</strong>
        {% if loan.back_end_dti %} {{ loan.back_end_dti }}% {% else %} N/A {% endif %}
    </p>
</section>



<!-- =======================================================
     BORROWER DOCUMENTS
======================================================= -->
<section class="section">
    <h3>üìÇ Borrower Documents</h3>

    {% if docs %}
        {% for d in docs %}
        <div class="doc-row">

            <strong>{{ d.name }}</strong><br>
            <span class="muted">Status: {{ d.status }}</span><br>

            {% if d.file_path %}
                <a href="{{ d.file_path }}" target="_blank" class="btn" style="margin-top:.5rem;">Open File</a>
            {% endif %}

            <form method="POST" style="margin-top:1rem;">
                <input type="hidden" name="doc_id" value="{{ d.id }}">

                <label>Processor Notes</label>
                <textarea name="notes" placeholder="Notes...">{{ d.processor_notes or "" }}</textarea>

                <div style="margin-top:.8rem;">
                    <button class="btn" name="action" value="approve">‚úî Approve</button>
                    <button class="btn" name="action" value="reject">‚úò Reject</button>
                </div>
            </form>

        </div>
        {% endfor %}
    {% else %}
        <p>No documents uploaded.</p>
    {% endif %}
</section>



<!-- =======================================================
     AI UNDERWRITING ASSISTANT
======================================================= -->
<section class="section">
    <h3>ü§ñ AI Underwriting Insights</h3>

    <textarea id="ai-input" placeholder="Ask: what else does underwriting need?"></textarea>
    <button class="btn" onclick="sendAI()">Ask AI</button>

    <div id="ai-response" style="margin-top:1rem;"></div>
</section>

</main>


<!-- =======================================================
     AI REQUEST SCRIPT
======================================================= -->
<script>
function sendAI() {
    let message = document.getElementById("ai-input").value;

    fetch("{{ url_for('master.ai') }}", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            message: message,
            borrower_id: {{ borrower.id }}
        })
    })
    .then(r => r.json())
    .then(data => {
        document.getElementById("ai-response").innerHTML = data.reply;
    });
}
</script>

{% endblock %}
