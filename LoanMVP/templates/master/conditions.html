{% extends "layouts/base.html" %}
{% block title %}Underwriting Conditions ‚Ä¢ Caughman Mason{% endblock %}

{% block content %}

<link rel="stylesheet" href="https://unpkg.com/lucide-static@latest/font/lucide.css">

<style>
    :root {
        --bg:#0f0f11;
        --panel:#15161a;
        --line:#2b2f36;
        --text:#e6e6e6;
        --muted:#a5a7ad;
        --accent:#7ab8ff;
        --hover:#1f2328;
        --glow:0 0 14px rgba(122,184,255,0.35);
    }

    body { background: var(--bg); color: var(--text); }

    .section {
        background: var(--panel);
        padding: 2rem;
        border-radius: 14px;
        border: 1px solid var(--line);
        margin-bottom: 2rem;
    }

    h2 { text-shadow: var(--glow); }

    .condition-box {
        background: #1a1c20;
        padding: 1rem;
        border-radius: 10px;
        border: 1px solid var(--line);
        margin-bottom: .7rem;
    }

    textarea {
        width: 100%;
        height: 80px;
        padding: .7rem;
        background: #1a1c20;
        border: 1px solid var(--line);
        border-radius: 10px;
        color: var(--text);
    }

    .btn {
        padding: .5rem 1rem;
        border-radius: 8px;
        border: 1px solid var(--accent);
        background: transparent;
        color: var(--accent);
        cursor: pointer;
    }
    .btn:hover { background: var(--accent); color: #000; }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
    }
    table td, table th {
        border-bottom: 1px solid var(--line);
        padding: .7rem;
    }

    #ai-box {
        background: var(--panel);
        padding: 1rem;
        border-radius: 12px;
        margin-top: 1.5rem;
        border: 1px solid var(--line);
    }
</style>


<main class="dashboard-main">

<!-- HEADER -->
<section class="section">
    <h2>üìù Underwriting Conditions</h2>

    <p class="muted">
        Borrower: <strong>{{ borrower.full_name }}</strong><br>
        Loan #: <strong>{{ loan.id }}</strong>
    </p>
</section>


<!-- =======================================================
     REQUEST NEW CONDITIONS
======================================================= -->
<section class="section">
    <h3>‚ûï Request New Conditions</h3>

    <form method="POST">

        <div class="grid-2" style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">

            <div class="condition-box">
                <label><input type="checkbox" name="conditions" value="Updated bank statements"> Updated bank statements</label>
            </div>
            <div class="condition-box">
                <label><input type="checkbox" name="conditions" value="CPA income letter"> CPA income letter</label>
            </div>
            <div class="condition-box">
                <label><input type="checkbox" name="conditions" value="Verification of employment"> Verification of employment</label>
            </div>
            <div class="condition-box">
                <label><input type="checkbox" name="conditions" value="Gift letter documentation"> Gift letter documentation</label>
            </div>
            <div class="condition-box">
                <label><input type="checkbox" name="conditions" value="Updated payoff statements"> Updated payoff statements</label>
            </div>
            <div class="condition-box">
                <label><input type="checkbox" name="conditions" value="Hazard insurance binder"> Hazard insurance binder</label>
            </div>
        </div>

        <label style="margin-top:1rem;">Notes (optional)</label>
        <textarea name="notes" placeholder="Additional detail for processor or borrower..."></textarea>

        <button class="btn" style="margin-top:1rem;">Submit Conditions</button>
    </form>
</section>


<!-- =======================================================
     CONDITION HISTORY
======================================================= -->
<section class="section">
    <h3>üìÑ Condition History</h3>

    <table>
        <thead>
            <tr>
                <th>Condition</th>
                <th>Status</th>
                <th>Notes</th>
                <th>Requested</th>
            </tr>
        </thead>

        <tbody>
        {% for c in all_conditions %}
            <tr>
                <td>{{ c.condition_name }}</td>
                <td>{{ c.status }}</td>
                <td>{{ c.notes or "‚Äî" }}</td>
                <td>{{ c.created_at.strftime("%b %d %I:%M %p") }}</td>
            </tr>
        {% else %}
            <tr><td colspan="4">No conditions yet.</td></tr>
        {% endfor %}
        </tbody>
    </table>
</section>
<section class="section">
    <h3>üìå Credit Summary</h3>

    {% if borrower.credit_reports %}
        {% set credit = borrower.credit_reports[-1] %}
        <p><strong>Score:</strong> {{ credit.credit_score }}</p>
        <p><strong>Date:</strong> {{ credit.created_at.strftime("%b %d, %Y %I:%M %p") }}</p>

        <a class="btn" href="#" onclick="alert(JSON.stringify({{ credit.credit_data|tojson }}, null, 2))">
            View Full Report JSON
        </a>
    {% else %}
        <p>No credit report available.</p>
    {% endif %}

    <form method="POST" action="/master/pull_credit/{{ borrower.id }}" style="margin-top:1rem;">
        <button class="btn">üîÑ Pull Soft Credit</button>
    </form>
</section>
<section class="section">
    <h3>üìä DTI & LTV Analysis</h3>

    <p><strong>LTV:</strong> 
        {% if ltv %} {{ (ltv * 100)|round(2) }}% {% else %} N/A {% endif %}
    </p>

    <p><strong>Front-End DTI:</strong> 
        {% if front_end_dti %} {{ (front_end_dti * 100)|round(2) }}% {% else %} N/A {% endif %}
    </p>

    <p><strong>Back-End DTI:</strong> 
        {% if back_end_dti %} {{ (back_end_dti * 100)|round(2) }}% {% else %} N/A {% endif %}
    </p>
</section>


<!-- =======================================================
     AI UNDERWRITING ASSISTANT
======================================================= -->
<section id="ai-box">
    <h3>ü§ñ AI Underwriting Insights</h3>

    <textarea id="ai-input" placeholder="Ask: what else does underwriting need?"></textarea>
    <button class="btn" onclick="sendAI()">Ask AI</button>

    <div id="ai-response" style="margin-top:1rem;"></div>
</section>

</main>


<script>
function sendAI() {
    let message = document.getElementById("ai-input").value;

    fetch("{{ url_for('master.ai') }}", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            message: message,
            borrower_id: {{ borrower.id }}
        })
    })
    .then(r => r.json())
    .then(data => {
        document.getElementById("ai-response").innerHTML = data.reply;
    });
}
</script>

{% endblock %}
