{% extends "layouts/base.html" %}
{% block title %}Message Thread{% endblock %}
{% block content %}

<div class="wrap">

    <section class="lhs">
        <div class="card">

            <!-- ⭐ CONSISTENT HEADER -->
            <div class="thread-header">
                <h2><i class="lucide lucide-message-circle"></i> Message Thread</h2>

                <a href="{{ url_for('processor.messages') }}" class="back-btn">
                    <i class="lucide lucide-arrow-left"></i> Back to Messages
                </a>
            </div>

            <p class="muted">
                Conversation with <strong>{{ thread_title }}</strong>
            </p>

            <!-- ⭐ THREAD BODY -->
            <div class="message-thread-body" id="messageBody">
                {% if messages %}
                    {% for msg in messages %}
                        <div class="message-bubble {% if msg.sender_id == current_user.id %}me{% else %}other{% endif %}">
                            <div class="msg-meta">
                                <span class="msg-sender">{{ msg.sender.full_name }}</span>
                                <span class="msg-time">{{ msg.created_at.strftime('%b %d, %Y %I:%M %p') }}</span>
                            </div>
                            <div class="msg-content">{{ msg.content|safe }}</div>
                        </div>
                    {% endfor %}
                {% else %}
                    <p class="muted">No messages yet. Start the conversation below.</p>
                {% endif %}
            </div>

            <!-- ⭐ INPUT BAR -->
            <form method="POST"
                  action="{{ url_for('processor.message_thread', partner_id=recipients[0].id) }}"
                  class="message-input-bar">

                <input type="text" name="message" placeholder="Type your message..." required>

                <button type="submit" class="btn-glow">
                    <i class="lucide lucide-send"></i>
                </button>
            </form>

        </div>
    </section>

    <aside class="rhs">
        <div class="card">
            <h3>Smart Tip</h3>
            <p class="muted">
                Use this space to coordinate tasks, request documents, or clarify borrower details.
            </p>
        </div>
    </aside>

</div>

<style>
/* ⭐ MATCH LIST PAGE LAYOUT */
.wrap {
    padding: 2rem;
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 1.5rem;
}

/* ⭐ HEADER */
.thread-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.back-btn {
    display: inline-flex;
    align-items: center;
    gap: .4rem;
    background: #111113;
    border: 1px solid var(--line);
    padding: .45rem .9rem;
    border-radius: 8px;
    color: var(--text);
    font-size: .9rem;
    text-decoration: none;
    transition: .2s ease;
}

.back-btn:hover {
    background: var(--accent);
    color: #000;
    box-shadow: var(--glow);
}

/* ⭐ THREAD BODY */
.message-thread-body {
    margin-top: 1rem;
    max-height: 65vh;
    overflow-y: auto;
    padding: 1rem 0.5rem;
}

/* ⭐ BUBBLES */
.message-bubble {
    width: 100%;
    padding: 1.2rem 1.4rem;
    margin-bottom: 1rem;
    border-radius: 12px;
    background: #1a1a1d;
}

.message-bubble.me {
    background: #2a2a2f;
    border-left: 3px solid var(--accent);
    margin-left: auto;
    max-width: 85%;
}

.message-bubble.other {
    background: #18181b;
    border-left: 3px solid var(--line);
    margin-right: auto;
    max-width: 85%;
}

.msg-meta {
    font-size: 0.85rem;
    color: var(--muted);
    margin-bottom: 0.5rem;
}

.msg-content {
    font-size: 1rem;
    line-height: 1.5;
}

/* ⭐ INPUT BAR */
.message-input-bar {
    display: flex;
    gap: 0.5rem;
    margin-top: 1rem;
    padding: 0.6rem;
    background: #111113;
    border-top: 1px solid var(--line);
    border-radius: 10px;
}

.message-input-bar input {
    flex: 1;
    padding: 0.65rem 0.9rem;
    border-radius: 10px;
    border: 1px solid var(--line);
    background: #0f0f11;
    color: var(--text);
    font-size: 0.95rem;
}
</style>

{% endblock %}
