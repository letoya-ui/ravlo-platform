{% set active_blueprint = request.blueprint %}
{% from "layouts/_dashboard_wrapper.html" import dashboard_wrapper %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{% block title %}LoanMVP | Caughman Mason{% endblock %}</title>

  {% block styles %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/theme.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/ai_widget.css') }}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  {% endblock %}
  <link rel="icon" type="image/x-icon" href="{{ url_for('favicon') }}">

<style>
/* ===========================================================
   ðŸŒŒ  C A U G H M A N   M A S O N   T H E M E
   =========================================================== */

:root {
    --bg:#0b0d10;
    --panel:#14171c;
    --line:#20242b;
    --text:#ffffff;
    --muted:#9aa0aa;
    --accent:#7ab8ff;
    --accent2:#a4d2ff;
    --hover:#1d2230;

    --glow-soft:0 0 18px rgba(122,184,255,0.25);
    --glow-strong:0 0 32px rgba(122,184,255,0.45);
    --radius:16px;
}

/* ===========================================================
   GLOBAL RESET â€” FIXED FOR CHAT
   =========================================================== */
html, body {
  margin:0;
  padding:0;
  height:100%;
  background:var(--bg);
  color:var(--text);
  font-family:"Inter", sans-serif;

  /* FIX: allow scrolling so chat input is reachable */
  overflow:auto;
}

img {
    max-width: 100%;
    height: auto;
}

/* FIX: avatar size */
.user-area img {
    width: 40px;
    height: 40px;
    object-fit: cover;
    border-radius: 50%;
}

/* ===========================================================
   MAIN SCROLL CONTAINER â€” FIXED
   =========================================================== */
.main-scroll {
  position:absolute;
  top:0; left:0; right:0; bottom:0;

  /* FIX: allow scrolling inside dashboard */
  overflow-y:auto;
  overflow-x:hidden;

  scroll-behavior:smooth;
  padding-top:60px;
  padding-left:260px;
}

/* Scrollbar */
.main-scroll::-webkit-scrollbar { width:12px; }
.main-scroll::-webkit-scrollbar-thumb {
  background:#d3d3d3;
  border-radius:6px;
  border:2px solid #1a1c1f;
}
.main-scroll::-webkit-scrollbar-thumb:hover { background:#fff; }

/* ===========================================================
   SIDEBAR + TOPBAR (unchanged)
   =========================================================== */

.sidebar {
  width:260px;
  position:fixed;
  left:0;
  top:0;
  bottom:0;
  background:var(--panel);
  border-right:1px solid var(--line);
  overflow-y:auto;
  box-shadow:var(--glow-soft);
  animation:cmPulse 1.5s infinite ease-in-out;
  z-index:200;
}

.topbar {
  position:fixed;
  top:0;
  left:260px;
  right:0;
  height:60px;
  background:var(--panel);
  border-bottom:1px solid var(--line);
  display:flex;
  justify-content:flex-end;
  align-items:center;
  padding:0 1.5rem;
  z-index:250;
  box-shadow:var(--glow-soft);
  animation:cmPulse 1.5s infinite ease-in-out;
}

/* ===========================================================
   MAIN CONTENT
   =========================================================== */
main {
  padding:2rem;
  min-height:calc(100vh - 60px);
}

.card {
  background:var(--panel);
  border:1px solid var(--line);
  border-radius:var(--radius);
  padding:1.4rem;
  box-shadow:var(--glow-soft);
  animation:cmPulse 1.5s infinite ease-in-out;
}

</style>
</head>

<body>

<!-- TOPBAR -->
<div class="topbar">
  <div class="notification-area">
    <button class="notif-btn" id="notifBell" onclick="toggleNotifications()">
      <i class="fa-solid fa-bell"></i>
      {% if g.get('unread_count', 0) > 0 %}
        <span class="notif-count">{{ g.unread_count }}</span>
      {% endif %}
    </button>

    <div class="notif-dropdown" id="notifDropdown">
      <h4 style="margin:0 0 .6rem 0;">Notifications</h4>
    </div>
  </div>

  {% if current_user.is_authenticated %}
  <div class="user-area" onclick="location.href='{{ url_for('auth.logout') }}'">
    <img src="{{ current_user.profile_pic or url_for('static', filename='images/default_user.png') }}">
    <span>{{ current_user.first_name or current_user.username }}</span>
  </div>
  {% endif %}
</div>

<!-- SIDEBAR -->
{% if current_user.is_authenticated %}
  {% set role = current_user.role|lower %}
  {% if role in ["admin"] %}
    {% include "layouts/_sidebar_admin.html" %}
  {% elif role in ["loan officer","loan_officer"] %}
    {% include "layouts/_sidebar_loan_officer.html" %}
  {% elif role=="processor" %}
    {% include "layouts/_sidebar_processor.html" %}
  {% elif role=="underwriter" %}
    {% include "layouts/_sidebar_underwriter.html" %}
  {% elif role=="crm" %}
    {% include "layouts/_sidebar_crm.html" %}
  {% elif role=="executive" %}
    {% include "layouts/_sidebar_executive.html" %}
  {% elif role=="property" %}
    {% include "layouts/_sidebar_property.html" %}
  {% endif %}
{% endif %}

<!-- MAIN CONTENT -->
<div class="main-scroll" id="mainScroll">
  <main>
    {% block content %}{% endblock %}
  </main>
</div>

<script>
/* Notification dropdown */
function toggleNotifications(){
  const dd=document.getElementById('notifDropdown');
  dd.style.display = (dd.style.display==='block') ? 'none' : 'block';
}

document.addEventListener("click", function(e){
  const dd = document.getElementById("notifDropdown");
  const btn = document.getElementById("notifBell");
  if(!dd.contains(e.target) && !btn.contains(e.target))
    dd.style.display = "none";
});
</script>

</body>
</html>