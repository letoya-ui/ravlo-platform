{# layouts/borrower_base.html #}
{% set ep = request.endpoint or "" %}

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>{% block title %}Borrower{% endblock %}</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="https://unpkg.com/lucide-static@latest/font/lucide.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/borrower.css') }}">

  <style>
    /* Ensure the main shell accounts for fixed sidebar */
    .borrower-shell { min-height: 100vh; }
    .b-right { margin-left: 64px; min-height: 100vh; }

    /* Tooltip baseline */
    .b-tooltip{
      color: var(--text) !important;
      background:#0b0c0f;
      padding:4px 8px;
      border-radius:6px;
      font-size:.75rem;
      white-space:nowrap;
      position:absolute;
      left:50px;
      opacity:0;
      pointer-events:none;
      transition:.2s ease;
    }
    .b-sidebar-item:hover .b-tooltip{ opacity:1; }
  </style>

  {% block head %}{% endblock %}
</head>

<body>
  <div class="borrower-shell">

    <!-- SLIM SIDEBAR (GLOBAL) -->
    <aside class="b-sidebar">
      <a class="b-sidebar-logo" href="{{ url_for('borrower.dashboard') }}">CM</a>

      <div class="b-sidebar-group">

        <!-- Dashboard -->
        <a class="b-sidebar-item {{ 'active' if ep == 'borrower.dashboard' else '' }}"
           href="{{ url_for('borrower.dashboard') }}">
          <i class="lucide lucide-layout-dashboard"></i>
          <span class="b-tooltip">Dashboard</span>
        </a>

        <a class="b-sidebar-item {{ 'active' if ep == 'borrower.property_tool' else '' }}"
           href="{{ url_for('borrower.property_tool') }}">
          <i class="lucide lucide-radar"></i>
          <span class="b-tooltip">Deal Finder</span>
        </a>
        
        <!-- Property Search -->
        <a class="b-sidebar-item {{ 'active' if ep in ['borrower.property_search','borrower.property_finder'] or 'property' in ep else '' }}"
           href="{{ url_for('borrower.property_search') }}">
          <i class="lucide lucide-search"></i>
          <span class="b-tooltip">Property Search</span>
        </a>

        <!-- Saved Properties (NEW in sidebar) -->
        <a class="b-sidebar-item {{ 'active' if ep == 'borrower.saved_properties' else '' }}"
           href="{{ url_for('borrower.saved_properties') }}">
          <i class="lucide lucide-bookmark"></i>
          <span class="b-tooltip">Saved Properties</span>
        </a>

        <!-- Deal Workspace -->
        <a class="b-sidebar-item {{ 'active' if ep == 'borrower.deal_workspace' or 'deal' in ep else '' }}"
           href="{{ url_for('borrower.deal_workspace') }}">
          <i class="lucide lucide-trending-up"></i>
          <span class="b-tooltip">Deal Workspace</span>
        </a>

        <!-- Loan View (NEW) -->
        <a class="b-sidebar-item {{ 'active' if ep in ['borrower.status','borrower.loan_view','borrower.loan_summary'] or 'loan' in ep else '' }}"
           href="{{ url_for('borrower.status') }}">
          <i class="lucide lucide-file-text"></i>
          <span class="b-tooltip">Loan View</span>
        </a>

        <!-- Payments -->
        <a class="b-sidebar-item {{ 'active' if ep == 'borrower.payments' or 'payment' in ep else '' }}"
           href="{{ url_for('borrower.payments') }}">
          <i class="lucide lucide-credit-card"></i>
          <span class="b-tooltip">Payments</span>
        </a>

        <!-- Support / Command Center -->
        <a class="b-sidebar-item {{ 'active' if ep == 'borrower.borrower_command_center' or 'command' in ep or 'support' in ep else '' }}"
           href="{{ url_for('borrower.borrower_command_center') }}">
          <i class="lucide lucide-headset"></i>
          <span class="b-tooltip">Support</span>
        </a>

      </div>

      <!-- Bottom -->
      <div class="b-sidebar-group b-sidebar-bottom">
        <a class="b-sidebar-item" href="{{ url_for('auth.logout') }}">
          <i class="lucide lucide-log-out"></i>
          <span class="b-tooltip">Logout</span>
        </a>
      </div>
    </aside>

    <!-- RIGHT SIDE -->
    <div class="b-right">

      <!-- WIDE TOPBAR -->
      <header class="b-topbar">
        <div class="b-topbar-left">
          {% block topbar_left %}
            <div class="b-topbar-title">
              {% block topbar_title %}Borrower OS{% endblock %}
            </div>
          {% endblock %}
        </div>

        <div class="b-topbar-right">
          {% block topbar_right %}
            <a class="b-topbar-icon" href="{{ url_for('notifications.inbox') if notifications_enabled else '#' }}">
              <i class="lucide lucide-bell"></i>
            </a>

            <div class="b-user-menu" id="bUserMenu">
              <button class="b-user-btn" type="button" id="bUserBtn" aria-haspopup="true" aria-expanded="false">
                <img
                  class="b-user-avatar"
                  src="{{ borrower.profile_pic if borrower and borrower.profile_pic else url_for('static', filename='images/default_user.png') }}"
                  alt="User">
                 <i class="lucide lucide-chevron-down b-user-caret"></i>
               </button>

              <div class="b-user-dropdown" id="bUserDropdown" role="menu" aria-label="User menu">
                 <div class="b-user-header">
                  <div class="b-user-name">{{ current_user.full_name if current_user else "Account" }}</div>
                    <div class="b-user-email">{{ current_user.email if current_user else "" }}</div>
                  </div>

                  <a class="b-user-item" href="{{ url_for('borrower.profile') if 'borrower.profile' in current_app.view_functions else '#' }}">
                  <i class="lucide lucide-user"></i> Profile
                </a>

                 <a class="b-user-item" href="{{ url_for('borrower.settings') if 'borrower.settings' in current_app.view_functions else '#' }}">
                     <i class="lucide lucide-settings"></i> Settings
                 </a>

                <a class="b-user-item" href="{{ url_for('borrower.privacy') if 'borrower.privacy' in current_app.view_functions else '#' }}">
                  <i class="lucide lucide-shield"></i> Privacy
                </a>

                <a class="b-user-item" href="{{ url_for('borrower.notifications_settings') if 'borrower.notifications_settings' in current_app.view_functions else '#' }}">
                  <i class="lucide lucide-bell"></i> Notifications
                </a>

                <div class="b-user-divider"></div>

                <a class="b-user-item danger" href="{{ url_for('auth.logout') }}">
                  <i class="lucide lucide-log-out"></i> Logout
                </a>
              </div>
            </div>
          {% endblock %}
        </div>
      </header>

      {% block top_tabs %}{% endblock %}

      <!-- MAIN -->
      <main class="b-main">
        <div class="b-main-inner">
          {% block content %}{% endblock %}
        </div>
      </main>

    </div>
  </div>

  {% block scripts %}{% endblock %}
</body>
</html>
